#!/bin/bash

# Script de verificaci√≥n del progreso de onboarding
# Este script te ayuda a verificar que el progreso se est√° leyendo correctamente

echo "================================================"
echo "üîç VERIFICACI√ìN DE PROGRESO DE ONBOARDING"
echo "================================================"
echo ""

# Configuraci√≥n
TENANT_ID="${1:-tu-tenant-id}"

if [ "$TENANT_ID" = "tu-tenant-id" ]; then
  echo "‚ùå Error: Debes proporcionar tu TENANT_ID"
  echo ""
  echo "Uso:"
  echo "  ./verificar-progreso.sh <TENANT_ID>"
  echo ""
  echo "Ejemplo:"
  echo "  ./verificar-progreso.sh abc123"
  echo ""
  exit 1
fi

echo "üìã Configuraci√≥n:"
echo "   Tenant ID: $TENANT_ID"
echo ""

echo "================================================"
echo "PASO 1: Verificar el progreso guardado en Firebase"
echo "================================================"
echo ""
echo "Abre la siguiente URL en tu navegador:"
echo ""
echo "https://console.firebase.google.com/project/kds-app-7f1d3/database/kds-app-7f1d3-default-rtdb/data/~2Ftenants~2F${TENANT_ID}~2Fonboarding"
echo ""
echo "Verifica que exista el campo 'progress' con un valor num√©rico (ej: 75)"
echo ""
read -p "Presiona Enter cuando hayas verificado..."
echo ""

echo "================================================"
echo "PASO 2: Abrir el dashboard con la consola del navegador"
echo "================================================"
echo ""
echo "1. Abre esta URL:"
echo "   https://kdsapp.site/dashboard.html?tenant=${TENANT_ID}"
echo ""
echo "2. Abre la consola del navegador (F12 ‚Üí Consola)"
echo ""
echo "3. Busca estos logs:"
echo ""
echo "   ‚úÖ Si el progreso se lee correctamente desde Firebase:"
echo "      üìä Progreso de onboarding le√≠do desde Firebase: XX%"
echo ""
echo "   ‚ö†Ô∏è  Si no existe en Firebase y se calcula:"
echo "      üìä Progreso de onboarding calculado (no exist√≠a en Firebase): XX%"
echo ""
echo "   üìä Estado inicial del bot:"
echo "      ü§ñ Estado inicial del bot: ON/OFF (progreso: XX%)"
echo ""
echo "   üé® UI del bot:"
echo "      üé® Actualizando UI del bot:"
echo "        - Estado del bot: ON/OFF"
echo "        - Progreso de onboarding: XX%"
echo "        - Puede activar (>= 75%): true/false"
echo ""
read -p "Presiona Enter cuando hayas abierto la consola..."
echo ""

echo "================================================"
echo "PASO 3: Intentar activar el bot"
echo "================================================"
echo ""
echo "1. Haz clic en el toggle del bot (si no est√° deshabilitado)"
echo ""
echo "2. Verifica estos logs en la consola:"
echo ""
echo "   üéØ Toggle bot llamado:"
echo "      - Estado actual del bot: OFF"
echo "      - Progreso local (onboardingPercentage): XX%"
echo "      - Puede activar (>= 75%): true/false"
echo "      - Estado de onboarding: {...}"
echo ""
echo "   üîç Validaci√≥n en Firebase:"
echo "      - Progreso guardado en Firebase: XX%"
echo "      - Steps en Firebase: {...}"
echo "      - Completed en Firebase: true/false"
echo ""
echo "   ‚úÖ Si se activa correctamente:"
echo "      ‚úÖ Estado del bot actualizado en Firebase: ACTIVO (true)"
echo ""
echo "   üö´ Si el progreso es < 75%:"
echo "      üö´ Validaci√≥n de progreso fall√≥."
echo "         - Progreso en Firebase: XX%"
echo "         - Progreso local: XX%"
echo ""
read -p "Presiona Enter cuando hayas probado el toggle..."
echo ""

echo "================================================"
echo "PASO 4: Verificar discrepancias"
echo "================================================"
echo ""
echo "Si el progreso local es diferente al de Firebase, se mostrar√°:"
echo ""
echo "   ‚ö†Ô∏è Discrepancia detectada entre progreso local (XX%) y Firebase (YY%). Sincronizando..."
echo ""
echo "Esto es NORMAL y el sistema se sincronizar√° autom√°ticamente."
echo ""
read -p "Presiona Enter para continuar..."
echo ""

echo "================================================"
echo "PASO 5: Verificar alertas en la UI"
echo "================================================"
echo ""
echo "1. Si el progreso es < 75% y intentas activar el bot:"
echo "   ‚Üí Ver√°s una alerta: '‚ö†Ô∏è Para activar el bot, debes completar al menos el 75%'"
echo ""
echo "2. Si hay discrepancia entre local y Firebase:"
echo "   ‚Üí Ver√°s una alerta con el progreso del servidor"
echo ""
echo "3. Si el progreso es >= 75%:"
echo "   ‚Üí El toggle debe estar habilitado y funcionando"
echo "   ‚Üí La advertencia no debe mostrarse"
echo ""
read -p "Presiona Enter para ver el resumen..."
echo ""

echo "================================================"
echo "üìä RESUMEN DE VERIFICACI√ìN"
echo "================================================"
echo ""
echo "‚úÖ Checklist:"
echo ""
echo "   [ ] El progreso se lee desde Firebase al cargar el dashboard"
echo "   [ ] Los logs muestran el progreso correcto (no 0%)"
echo "   [ ] El toggle se habilita si progreso >= 75%"
echo "   [ ] El toggle se deshabilita si progreso < 75%"
echo "   [ ] La validaci√≥n en Firebase funciona al activar el bot"
echo "   [ ] Las alertas se muestran correctamente"
echo "   [ ] No hay errores en la consola del navegador"
echo ""
echo "================================================"
echo ""
echo "Si alguno de estos checks falla, copia los logs de la consola"
echo "y comp√°rtelos para investigar el problema."
echo ""
echo "Logs importantes:"
echo "   - üìä Progreso de onboarding le√≠do desde Firebase: XX%"
echo "   - ü§ñ Estado inicial del bot: ON/OFF (progreso: XX%)"
echo "   - üéØ Toggle bot llamado: {...}"
echo "   - üîç Validaci√≥n en Firebase: {...}"
echo ""
echo "================================================"
echo "‚úÖ Verificaci√≥n completada"
echo "================================================"
