<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üîç Diagn√≥stico de T√∫nel - KDS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .diagnostic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-item {
      padding: 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      background: #f5f5f5;
    }

    .status-item strong {
      display: block;
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 5px;
    }

    .status-item span {
      font-size: 1.1rem;
      color: #333;
    }

    .status-good {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }

    .status-bad {
      background: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    .status-warn {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .log-container {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .log-entry {
      margin-bottom: 8px;
      padding: 4px 0;
    }

    .log-error { color: #f48771; }
    .log-warn { color: #dcdcaa; }
    .log-info { color: #4ec9b0; }
    .log-success { color: #b5cea8; }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .badge-success {
      background: #28a745;
      color: white;
    }

    .badge-danger {
      background: #dc3545;
      color: white;
    }

    .badge-warning {
      background: #ffc107;
      color: #333;
    }

    .ws-test {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    .ws-test h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .ws-status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Diagn√≥stico Completo de T√∫nel</h1>
      <p>Verificaci√≥n del sistema de t√∫nel WebSocket</p>
    </div>

    <div class="diagnostic-grid">
      <!-- Service Worker Status -->
      <div class="card">
        <h2>üîß Service Worker</h2>
        <div id="sw-status"></div>
        <div class="actions">
          <button class="btn btn-primary" onclick="checkServiceWorker()">Verificar</button>
          <button class="btn btn-primary" onclick="registerServiceWorker()">Registrar</button>
        </div>
      </div>

      <!-- T√∫nel API Status -->
      <div class="card">
        <h2>üåê Estado del T√∫nel</h2>
        <div id="tunnel-status"></div>
        <div class="actions">
          <button class="btn btn-primary" onclick="checkTunnelAPI()">Verificar API</button>
        </div>
      </div>

      <!-- Tenant Info -->
      <div class="card">
        <h2>üë§ Informaci√≥n Tenant</h2>
        <div id="tenant-info"></div>
        <div class="actions">
          <button class="btn btn-primary" onclick="checkTenantInfo()">Verificar</button>
        </div>
      </div>
    </div>

    <!-- WebSocket Test -->
    <div class="card ws-test">
      <h3>üîå Prueba de WebSocket</h3>
      <div id="ws-status" class="ws-status"></div>
      <div class="actions">
        <button class="btn btn-primary" onclick="testWebSocket()">Probar WebSocket</button>
        <button class="btn btn-danger" onclick="closeWebSocket()">Cerrar</button>
      </div>
    </div>

    <!-- Logs -->
    <div class="card">
      <h2>üìã Logs de Diagn√≥stico</h2>
      <div id="logs" class="log-container"></div>
      <div class="actions">
        <button class="btn btn-primary" onclick="clearLogs()">Limpiar</button>
      </div>
    </div>
  </div>

  <script>
    let wsConnection = null;
    const logs = [];

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const entry = { timestamp, message, type };
      logs.push(entry);
      
      const logsDiv = document.getElementById('logs');
      const logClass = `log-${type}`;
      logsDiv.innerHTML += `<div class="log-entry ${logClass}">[${timestamp}] ${message}</div>`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearLogs() {
      logs.length = 0;
      document.getElementById('logs').innerHTML = '';
      log('Logs limpiados', 'info');
    }

    // ========================================
    // Service Worker Checks
    // ========================================

    async function checkServiceWorker() {
      log('Verificando Service Worker...', 'info');
      
      const statusDiv = document.getElementById('sw-status');
      
      if (!('serviceWorker' in navigator)) {
        statusDiv.innerHTML = '<div class="status-item status-bad"><strong>Estado:</strong> <span>‚ùå No soportado</span></div>';
        log('Service Workers no soportados en este navegador', 'error');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.getRegistration('/');
        
        if (!registration) {
          statusDiv.innerHTML = '<div class="status-item status-bad"><strong>Estado:</strong> <span>‚ùå No registrado</span></div>';
          log('Service Worker no est√° registrado', 'warn');
          return;
        }

        const hasController = navigator.serviceWorker.controller !== null;
        const state = registration.active?.state || 'unknown';
        
        const html = `
          <div class="status-item ${hasController ? 'status-good' : 'status-warn'}">
            <strong>Estado:</strong> <span>${hasController ? '‚úÖ Activo' : '‚ö†Ô∏è Registrado pero no activo'}</span>
          </div>
          <div class="status-item">
            <strong>Scope:</strong> <span>${registration.scope}</span>
          </div>
          <div class="status-item">
            <strong>State:</strong> <span>${state}</span>
          </div>
          <div class="status-item">
            <strong>Controlando:</strong> <span>${hasController ? 'S√≠' : 'No'}</span>
          </div>
        `;
        
        statusDiv.innerHTML = html;
        log(`Service Worker: ${hasController ? 'Activo y controlando' : 'Registrado pero no controlando'}`, hasController ? 'success' : 'warn');
        
      } catch (error) {
        log(`Error verificando Service Worker: ${error.message}`, 'error');
        statusDiv.innerHTML = `<div class="status-item status-bad"><strong>Error:</strong> <span>${error.message}</span></div>`;
      }
    }

    async function registerServiceWorker() {
      log('Registrando Service Worker...', 'info');
      
      try {
        const registration = await navigator.serviceWorker.register('/sw-tunnel.js', { scope: '/' });
        log('Service Worker registrado correctamente', 'success');
        log('Recarga la p√°gina para que tome control', 'info');
        
        setTimeout(checkServiceWorker, 1000);
      } catch (error) {
        log(`Error registrando Service Worker: ${error.message}`, 'error');
      }
    }

    // ========================================
    // T√∫nel API Checks
    // ========================================

    async function checkTunnelAPI() {
      log('Verificando API del T√∫nel...', 'info');
      
      const statusDiv = document.getElementById('tunnel-status');
      
      if (!window.KDSTunnel) {
        statusDiv.innerHTML = '<div class="status-item status-bad"><strong>Estado:</strong> <span>‚ùå API no cargada</span></div>';
        log('API del t√∫nel (window.KDSTunnel) no est√° disponible', 'error');
        return;
      }

      const isActive = window.KDSTunnel.isActive();
      const status = window.KDSTunnel.getStatus();
      
      const html = `
        <div class="status-item ${isActive ? 'status-good' : 'status-bad'}">
          <strong>Estado:</strong> <span>${isActive ? '‚úÖ Activo' : '‚ùå Inactivo'}</span>
        </div>
        <div class="status-item">
          <strong>Status:</strong> <span class="badge badge-${status.status === 'active' ? 'success' : 'danger'}">${status.status}</span>
        </div>
        <div class="status-item">
          <strong>SW Ready:</strong> <span>${status.isServiceWorkerReady ? 'S√≠' : 'No'}</span>
        </div>
        <div class="status-item">
          <strong>Tenant ID:</strong> <span>${status.tenantId || 'No detectado'}</span>
        </div>
        <div class="status-item">
          <strong>√öltima actualizaci√≥n:</strong> <span>${new Date(status.timestamp).toLocaleTimeString()}</span>
        </div>
      `;
      
      statusDiv.innerHTML = html;
      log(`API del T√∫nel - Estado: ${status.status}, Activo: ${isActive}`, isActive ? 'success' : 'warn');
    }

    // ========================================
    // Tenant Info
    // ========================================

    function checkTenantInfo() {
      log('Verificando informaci√≥n de Tenant...', 'info');
      
      const statusDiv = document.getElementById('tenant-info');
      
      // Intentar obtener de m√∫ltiples fuentes
      const urlParams = new URLSearchParams(window.location.search);
      const fromUrl = urlParams.get('tenant') || urlParams.get('tenantId');
      const fromLocalStorage = localStorage.getItem('tenantId');
      const fromSessionStorage = sessionStorage.getItem('tenantId');
      
      const html = `
        <div class="status-item ${fromUrl ? 'status-good' : 'status-warn'}">
          <strong>URL Params:</strong> <span>${fromUrl || 'No detectado'}</span>
        </div>
        <div class="status-item ${fromLocalStorage ? 'status-good' : 'status-warn'}">
          <strong>LocalStorage:</strong> <span>${fromLocalStorage || 'No detectado'}</span>
        </div>
        <div class="status-item ${fromSessionStorage ? 'status-good' : 'status-warn'}">
          <strong>SessionStorage:</strong> <span>${fromSessionStorage || 'No detectado'}</span>
        </div>
      `;
      
      statusDiv.innerHTML = html;
      
      if (fromUrl || fromLocalStorage || fromSessionStorage) {
        log(`Tenant ID detectado: ${fromUrl || fromLocalStorage || fromSessionStorage}`, 'success');
      } else {
        log('No se detect√≥ Tenant ID en ninguna fuente', 'warn');
      }
    }

    // ========================================
    // WebSocket Test
    // ========================================

    function testWebSocket() {
      log('Iniciando prueba de WebSocket...', 'info');
      
      const statusDiv = document.getElementById('ws-status');
      
      // Obtener tenant ID
      const urlParams = new URLSearchParams(window.location.search);
      const tenantId = urlParams.get('tenant') || urlParams.get('tenantId') || 
                      localStorage.getItem('tenantId') || 
                      'TEST_TENANT';
      
      log(`Usando Tenant ID: ${tenantId}`, 'info');
      
      // Cerrar conexi√≥n anterior si existe
      if (wsConnection) {
        wsConnection.close();
      }
      
      // Crear WebSocket
      const wsUrl = `wss://api.kdsapp.site/tunnel?tenantId=${tenantId}`;
      log(`Conectando a: ${wsUrl}`, 'info');
      
      wsConnection = new WebSocket(wsUrl);
      
      wsConnection.onopen = () => {
        statusDiv.innerHTML = '<div class="ws-status status-good">‚úÖ WebSocket Conectado</div>';
        log('WebSocket conectado exitosamente', 'success');
        
        // Enviar mensaje de inicializaci√≥n
        const initMessage = {
          type: 'tunnel.init',
          deviceInfo: {
            userAgent: navigator.userAgent,
            timestamp: Date.now(),
            page: window.location.pathname,
            tenantId: tenantId
          }
        };
        
        wsConnection.send(JSON.stringify(initMessage));
        log('Mensaje de inicializaci√≥n enviado', 'info');
      };
      
      wsConnection.onmessage = (event) => {
        log(`üì® Mensaje recibido: ${event.data}`, 'info');
        
        try {
          const data = JSON.parse(event.data);
          log(`Tipo: ${data.type}`, 'info');
        } catch (e) {
          log(`Mensaje no JSON: ${event.data}`, 'warn');
        }
      };
      
      wsConnection.onerror = (error) => {
        statusDiv.innerHTML = '<div class="ws-status status-bad">‚ùå Error en WebSocket</div>';
        log(`Error en WebSocket: ${error.message || 'Desconocido'}`, 'error');
      };
      
      wsConnection.onclose = (event) => {
        statusDiv.innerHTML = `<div class="ws-status status-warn">‚ö†Ô∏è WebSocket Cerrado (${event.code})</div>`;
        log(`WebSocket cerrado - Code: ${event.code}, Reason: ${event.reason || 'N/A'}`, 'warn');
      };
    }

    function closeWebSocket() {
      if (wsConnection) {
        wsConnection.close();
        log('WebSocket cerrado manualmente', 'info');
      } else {
        log('No hay WebSocket activo para cerrar', 'warn');
      }
    }

    // ========================================
    // Auto-check on load
    // ========================================

    window.addEventListener('load', () => {
      log('Iniciando diagn√≥stico autom√°tico...', 'info');
      
      setTimeout(() => {
        checkServiceWorker();
        checkTunnelAPI();
        checkTenantInfo();
      }, 500);
    });

    // Escuchar eventos del t√∫nel si existe
    if (window.KDSTunnel) {
      window.KDSTunnel.on('connected', (data) => {
        log(`üåê T√∫nel conectado: ${data.tenantId}`, 'success');
      });
      
      window.KDSTunnel.on('disconnected', (data) => {
        log(`‚ö†Ô∏è T√∫nel desconectado: ${data.reason}`, 'warn');
      });
      
      window.KDSTunnel.on('error', (data) => {
        log(`‚ùå Error en t√∫nel: ${data.error}`, 'error');
      });
    }
  </script>
</body>
</html>
