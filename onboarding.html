<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conecta tu WhatsApp - KDS Platform</title>
  <meta name="description" content="Conecta tu WhatsApp Business en 1 clic y comienza a recibir pedidos autom√°ticamente">
  <link rel="icon" type="image/png" href="assets/images/kds-logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .onboarding-container {
      max-width: 600px;
      width: 100%;
      padding: 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .onboarding-logo {
      width: 120px;
      height: 120px;
      margin: 0 auto 30px;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .onboarding-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .onboarding-title {
      font-size: 32px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 16px;
      line-height: 1.2;
    }

    .onboarding-subtitle {
      font-size: 18px;
      color: #4a5568;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .onboarding-description {
      font-size: 16px;
      color: #718096;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .options-container {
      margin-bottom: 40px;
      padding: 30px;
      background: #f7fafc;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    /* ====================================
       SECCI√ìN CR√çTICA: Business Portfolio
       ==================================== */
    .critical-notice {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 3px solid #f59e0b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 30px;
      display: flex;
      gap: 20px;
      align-items: flex-start;
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
      animation: pulseWarning 2s ease-in-out infinite;
    }

    @keyframes pulseWarning {
      0%, 100% {
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.2);
      }
      50% {
        box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
      }
    }

    .notice-icon {
      font-size: 48px;
      flex-shrink: 0;
      animation: shake 1s ease-in-out infinite;
    }

    @keyframes shake {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-5deg); }
      75% { transform: rotate(5deg); }
    }

    .notice-content {
      flex: 1;
    }

    .notice-title {
      font-size: 20px;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 12px;
      line-height: 1.3;
    }

    .notice-text {
      font-size: 15px;
      color: #78350f;
      margin-bottom: 16px;
      line-height: 1.6;
    }

    .notice-highlight {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border-left: 4px solid #10b981;
      margin: 16px 0;
      font-size: 14px;
      line-height: 1.8;
    }

    .notice-highlight strong {
      display: block;
      margin-bottom: 4px;
    }

    .notice-explanation {
      font-size: 14px;
      color: #92400e;
      line-height: 1.6;
      margin-bottom: 16px;
    }

    .btn-understand {
      background: #10b981;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-understand:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    /* ====================================
       MODAL: Gu√≠a de Portfolio
       ==================================== */
    .portfolio-guide-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      padding: 20px;
      overflow-y: auto;
      backdrop-filter: blur(8px);
    }

    .portfolio-guide-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .portfolio-guide-content {
      background: white;
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      padding: 40px;
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
      animation: slideUpModal 0.4s ease-out;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideUpModal {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .portfolio-guide-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #10b981;
    }

    .portfolio-guide-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 12px;
    }

    .portfolio-guide-subtitle {
      font-size: 16px;
      color: #718096;
      line-height: 1.5;
    }

    .guide-step-card {
      background: #f7fafc;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 2px solid #e2e8f0;
    }

    .guide-step-card.highlight {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .guide-step-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }

    .guide-step-number {
      background: #10b981;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .guide-step-card.highlight .guide-step-number {
      background: #f59e0b;
    }

    .guide-step-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
    }

    .guide-step-text {
      font-size: 15px;
      color: #4a5568;
      line-height: 1.6;
      margin-bottom: 12px;
    }

    .guide-screenshot-placeholder {
      background: #e2e8f0;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      color: #718096;
      font-style: italic;
      margin-top: 12px;
    }

    .guide-do-dont {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .guide-do, .guide-dont {
      padding: 16px;
      border-radius: 8px;
      font-size: 14px;
    }

    .guide-do {
      background: #d1fae5;
      border: 2px solid #10b981;
    }

    .guide-dont {
      background: #fee2e2;
      border: 2px solid #ef4444;
    }

    .guide-do strong, .guide-dont strong {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .btn-close-guide {
      background: #667eea;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      transition: all 0.3s ease;
    }

    .btn-close-guide:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    .options-container {
      margin-bottom: 40px;
      padding: 30px;
      background: #f7fafc;
      border-radius: 12px;
      border: 2px solid #e2e8f0;
    }

    .options-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
    }

    .option-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 2px solid #e2e8f0;
      text-align: left;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .option-card:hover {
      border-color: #25D366;
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.1);
    }

    .option-card.selected {
      border-color: #25D366;
      background: #f0fdf4;
    }

    .option-title {
      font-size: 18px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .option-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .badge-recommended {
      background: #25D366;
      color: white;
    }

    .badge-new {
      background: #667eea;
      color: white;
    }

    .option-description {
      font-size: 14px;
      color: #718096;
      line-height: 1.5;
    }

    .option-icon {
      font-size: 24px;
    }

    .warning-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
      text-align: left;
    }

    .warning-box strong {
      color: #856404;
      display: block;
      margin-bottom: 8px;
    }

    .warning-box p {
      color: #856404;
      font-size: 14px;
      margin: 0;
    }

    .btn-connect-whatsapp {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: #25D366;
      color: white;
      padding: 18px 36px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
      border: none;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-connect-whatsapp:hover {
      background: #20BA5A;
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(37, 211, 102, 0.5);
    }

    .btn-connect-whatsapp:active {
      transform: translateY(0);
    }

    .btn-connect-whatsapp:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      transform: none;
    }

    .whatsapp-icon {
      font-size: 28px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.1);
      }
    }

    .features-list {
      text-align: left;
      margin-top: 50px;
      padding-top: 40px;
      border-top: 2px solid #e2e8f0;
    }

    .features-title {
      font-size: 20px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 24px;
      text-align: center;
    }

    .feature-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 20px;
      padding: 16px;
      background: #f7fafc;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .feature-item:hover {
      background: #edf2f7;
      transform: translateX(4px);
    }

    .feature-icon {
      font-size: 28px;
      flex-shrink: 0;
      line-height: 1;
    }

    .feature-text {
      flex: 1;
    }

    .feature-text strong {
      display: block;
      color: #2d3748;
      font-size: 16px;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .feature-text span {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    .loading-state {
      display: none;
      align-items: center;
      gap: 12px;
      color: #718096;
      font-size: 14px;
      margin-top: 20px;
    }

    .loading-state.active {
      display: flex;
      justify-content: center;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      display: none;
      background: #fed7d7;
      color: #c53030;
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
      font-size: 14px;
      text-align: left;
    }

    .error-message.active {
      display: block;
    }

    .back-link {
      display: inline-block;
      margin-top: 30px;
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.3s ease;
    }

    .back-link:hover {
      color: #764ba2;
      text-decoration: underline;
    }

    /* Modal de ayuda para n√∫mero registrado */
    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .help-modal.active {
      display: flex;
    }

    .help-modal-content {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.3s ease-out;
    }

    .help-modal-header {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }

    .help-modal-icon {
      font-size: 48px;
      flex-shrink: 0;
    }

    .help-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 8px;
    }

    .help-modal-subtitle {
      font-size: 16px;
      color: #718096;
      line-height: 1.5;
    }

    .help-steps {
      background: #f7fafc;
      border-radius: 12px;
      padding: 24px;
      margin: 24px 0;
    }

    .help-step {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .help-step:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .step-number {
      width: 32px;
      height: 32px;
      background: #667eea;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }

    .step-text {
      flex: 1;
      color: #2d3748;
      line-height: 1.6;
    }

    .help-tip {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 16px;
      margin: 20px 0;
      border-radius: 4px;
    }

    .help-tip strong {
      color: #856404;
      display: block;
      margin-bottom: 8px;
    }

    .help-tip p {
      color: #856404;
      margin: 0;
      font-size: 14px;
      line-height: 1.6;
    }

    .help-modal-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-modal {
      flex: 1;
      padding: 14px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #2d3748;
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .onboarding-container {
        padding: 30px 20px;
      }

      .onboarding-title {
        font-size: 26px;
      }

      .onboarding-subtitle {
        font-size: 16px;
      }

      .btn-connect-whatsapp {
        padding: 16px 28px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="onboarding-container">
    <div class="onboarding-logo">
      <img src="assets/images/kds-logo.webp" alt="KDS Logo" onerror="this.src='assets/images/kds-logo.png'">
    </div>

    <h1 class="onboarding-title">üöÄ Conecta tu WhatsApp Business</h1>
    
    <p class="onboarding-subtitle">
      Elige c√≥mo quieres configurar tu cuenta
    </p>

    <!-- ADVERTENCIA CR√çTICA: Business Portfolio -->
    <div class="critical-notice">
      <div class="notice-icon">üö®</div>
      <div class="notice-content">
        <h3 class="notice-title">¬°MUY IMPORTANTE! Lee esto antes de continuar</h3>
        <p class="notice-text">
          Durante el proceso de conexi√≥n, Facebook te preguntar√° <strong>qu√© Business Portfolio usar</strong>.
        </p>
        <div class="notice-highlight">
          <strong>‚úÖ DEBES SELECCIONAR:</strong> "KDS Platform" o el portfolio de la empresa tecnol√≥gica<br>
          <strong>‚ùå NO SELECCIONAR:</strong> Tu propio portfolio o el de tu restaurante
        </div>
        <p class="notice-explanation">
          Si seleccionas tu propio portfolio (no verificado), tu n√∫mero quedar√° en estado "Pendiente" 
          por 24-48 horas hasta que Meta lo apruebe. Con el portfolio de KDS (ya verificado), 
          <strong>tu n√∫mero se activa INSTANT√ÅNEAMENTE</strong> y puedes empezar a recibir pedidos de inmediato.
        </p>
        <button class="btn-understand" onclick="showPortfolioGuideModal()">
          üìñ Ver gu√≠a visual paso a paso
        </button>
      </div>
    </div>

    <div class="options-container">
      <h3 class="options-title">¬øTienes un n√∫mero de WhatsApp Business?</h3>

      <div class="option-card" data-option="migrate">
        <div class="option-title">
          <span class="option-icon">üîÑ</span>
          <span>Ya tengo WhatsApp Business</span>
          <span class="option-badge badge-recommended">RECOMENDADO</span>
        </div>
        <p class="option-description">
          Conecta tu n√∫mero actual de WhatsApp Business. Tus clientes seguir√°n usando el mismo n√∫mero que conocen. 
          Solo cambiar√°s la forma de gestionar los pedidos.
        </p>
      </div>

      <div class="option-card" data-option="new">
        <div class="option-title">
          <span class="option-icon">‚ú®</span>
          <span>Quiero registrar un n√∫mero nuevo</span>
          <span class="option-badge badge-new">NUEVO</span>
        </div>
        <p class="option-description">
          Registra un nuevo n√∫mero de tel√©fono para WhatsApp Business. 
          Ideal si est√°s empezando o quieres separar tu l√≠nea personal.
        </p>
      </div>

      <div class="warning-box" id="migration-warning" style="display: none;">
        <strong>‚ö†Ô∏è Importante: Si eliges migrar tu n√∫mero existente</strong>
        <p>
          ‚Ä¢ Tu app de WhatsApp Business en el tel√©fono dejar√° de funcionar<br>
          ‚Ä¢ Tus clientes NO necesitan hacer nada<br>
          ‚Ä¢ Tu n√∫mero sigue siendo el mismo<br>
          ‚Ä¢ Todas tus conversaciones se preservan<br>
          ‚Ä¢ Necesitar√°s tener acceso al tel√©fono para verificar<br>
          <br>
          <strong>‚ö†Ô∏è Si ves error "This number is registered...":</strong><br>
          Debes <a href="COMO-DESCONECTAR-WHATSAPP.md" target="_blank" style="color: #856404; text-decoration: underline; font-weight: 600;">desconectar tu n√∫mero primero</a> 
          desde la app de WhatsApp Business en tu tel√©fono (Configuraci√≥n ‚Üí Cuenta ‚Üí Eliminar cuenta). 
          <a href="COMO-DESCONECTAR-WHATSAPP.md" target="_blank" style="color: #856404; text-decoration: underline;">Ver gu√≠a completa ‚Üí</a>
        </p>
      </div>
    </div>

    <button id="btn-connect" class="btn-connect-whatsapp" disabled>
      <span class="whatsapp-icon">üì±</span>
      Conectar WhatsApp Ahora
    </button>

    <div class="loading-state" id="loading-state">
      <div class="spinner"></div>
      <span>Conectando con Facebook...</span>
    </div>

    <div class="error-message" id="error-message">
      <strong>‚ö†Ô∏è Error de conexi√≥n</strong>
      <p id="error-text"></p>
    </div>

    <div class="features-list">
      <h3 class="features-title">‚ú® Lo que obtienes</h3>

      <div class="feature-item">
        <div class="feature-icon">‚ö°</div>
        <div class="feature-text">
          <strong>Configuraci√≥n instant√°nea</strong>
          <span>Sin complicaciones t√©cnicas. Solo autoriza tu cuenta de WhatsApp Business y estar√°s listo para recibir pedidos en segundos.</span>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">ü§ñ</div>
        <div class="feature-text">
          <strong>Bot inteligente incluido</strong>
          <span>Toma pedidos autom√°ticamente 24/7. Entiende lenguaje natural y confirma cada orden antes de enviarla a cocina.</span>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">üìä</div>
        <div class="feature-text">
          <strong>Dashboard en tiempo real</strong>
          <span>Visualiza y gestiona todos tus pedidos en una pantalla de cocina moderna y f√°cil de usar.</span>
        </div>
      </div>

      <div class="feature-item">
        <div class="feature-icon">üîí</div>
        <div class="feature-text">
          <strong>100% seguro y privado</strong>
          <span>Tus credenciales est√°n cifradas. Cumplimos con todas las pol√≠ticas de seguridad de Meta y protegemos tus datos.</span>
        </div>
      </div>
    </div>

    <a href="index.html" class="back-link">‚Üê Volver al inicio</a>
  </div>

  <!-- Modal de ayuda para n√∫mero registrado -->
  <div class="help-modal" id="help-modal">
    <div class="help-modal-content">
      <div class="help-modal-header">
        <div class="help-modal-icon">‚ö†Ô∏è</div>
        <div>
          <h2 class="help-modal-title">N√∫mero ya registrado</h2>
          <p class="help-modal-subtitle">
            Este n√∫mero ya est√° conectado a WhatsApp Business App en un tel√©fono. 
            Necesitas desconectarlo primero.
          </p>
        </div>
      </div>

      <div class="help-steps">
        <div class="help-step">
          <div class="step-number">1</div>
          <div class="step-text">
            Abre <strong>WhatsApp Business</strong> en tu tel√©fono
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">2</div>
          <div class="step-text">
            Toca los <strong>3 puntos (‚ãÆ)</strong> ‚Üí <strong>Configuraci√≥n</strong> ‚Üí <strong>Cuenta</strong>
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">3</div>
          <div class="step-text">
            Toca <strong>"Eliminar cuenta"</strong> y confirma
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">4</div>
          <div class="step-text">
            <strong>Espera 10-15 minutos</strong> para que el n√∫mero se libere
          </div>
        </div>
        <div class="help-step">
          <div class="step-number">5</div>
          <div class="step-text">
            Regresa aqu√≠ e intenta nuevamente
          </div>
        </div>
      </div>

      <div class="help-tip">
        <strong>üí° Consejo:</strong>
        <p>
          Si no quieres perder acceso a tu app del tel√©fono, considera usar un 
          <strong>n√∫mero diferente</strong> para la automatizaci√≥n. As√≠ mantienes 
          tu n√∫mero actual en el tel√©fono y usas uno nuevo para pedidos autom√°ticos.
        </p>
      </div>

      <div class="help-modal-actions">
        <button class="btn-modal btn-secondary" onclick="closeHelpModal()">
          Cerrar
        </button>
        <a href="COMO-DESCONECTAR-WHATSAPP.md" target="_blank" class="btn-modal btn-primary" style="text-decoration: none; text-align: center; display: flex; align-items: center; justify-content: center;">
          Ver gu√≠a completa
        </a>
      </div>
    </div>
  </div>

  <!-- Modal: Gu√≠a de selecci√≥n de Business Portfolio -->
  <div class="portfolio-guide-modal" id="portfolio-guide-modal">
    <div class="portfolio-guide-content">
      <div class="portfolio-guide-header">
        <h2 class="portfolio-guide-title">üìñ Gu√≠a: C√≥mo Seleccionar el Portfolio Correcto</h2>
        <p class="portfolio-guide-subtitle">
          Sigue estos pasos para que tu n√∫mero quede activo INSTANT√ÅNEAMENTE
        </p>
      </div>

      <div class="guide-step-card">
        <div class="guide-step-header">
          <div class="guide-step-number">1</div>
          <div class="guide-step-title">Haz clic en "Conectar WhatsApp Ahora"</div>
        </div>
        <p class="guide-step-text">
          Se abrir√° una ventana emergente de Facebook para autorizar la conexi√≥n.
        </p>
      </div>

      <div class="guide-step-card">
        <div class="guide-step-header">
          <div class="guide-step-number">2</div>
          <div class="guide-step-title">Inicia sesi√≥n con tu cuenta de Facebook</div>
        </div>
        <p class="guide-step-text">
          Usa la cuenta de Facebook que quieres vincular con el sistema.
        </p>
      </div>

      <div class="guide-step-card highlight">
        <div class="guide-step-header">
          <div class="guide-step-number">3</div>
          <div class="guide-step-title">üö® PASO CR√çTICO: Selecciona el Business Portfolio</div>
        </div>
        <p class="guide-step-text">
          Facebook te preguntar√°: <strong>"¬øQu√© Business Portfolio quieres usar?"</strong>
        </p>
        
        <div class="guide-do-dont">
          <div class="guide-do">
            <strong>‚úÖ DEBES HACER:</strong>
            Selecciona <strong>"KDS Platform"</strong> o el portfolio de la empresa tecnol√≥gica.<br><br>
            Este portfolio YA est√° verificado por Meta, por lo que tu n√∫mero se activar√° INMEDIATAMENTE.
          </div>
          <div class="guide-dont">
            <strong>‚ùå NO HACER:</strong>
            NO selecciones tu propio portfolio o el de tu restaurante.<br><br>
            Si lo haces, tu n√∫mero quedar√° en "Pendiente" por 24-48 horas hasta que Meta apruebe el portfolio.
          </div>
        </div>

        <div class="guide-screenshot-placeholder">
          üì∏ Captura de pantalla: En esta ventana ver√°s una lista de portfolios disponibles.<br>
          Busca "KDS Platform" o pregunta cu√°l es el portfolio verificado a usar.
        </div>
      </div>

      <div class="guide-step-card">
        <div class="guide-step-header">
          <div class="guide-step-number">4</div>
          <div class="guide-step-title">Ingresa tu n√∫mero de WhatsApp</div>
        </div>
        <p class="guide-step-text">
          ‚Ä¢ Si vas a <strong>migrar</strong> un n√∫mero existente: ingresa ese n√∫mero<br>
          ‚Ä¢ Si vas a <strong>registrar</strong> un n√∫mero nuevo: ingresa el nuevo n√∫mero<br>
          ‚Ä¢ Aseg√∫rate de tener acceso al tel√©fono para recibir el c√≥digo de verificaci√≥n
        </p>
      </div>

      <div class="guide-step-card">
        <div class="guide-step-header">
          <div class="guide-step-number">5</div>
          <div class="guide-step-title">Verifica el n√∫mero con el c√≥digo SMS</div>
        </div>
        <p class="guide-step-text">
          Recibir√°s un c√≥digo de 6 d√≠gitos por SMS. Ingr√©salo para completar la verificaci√≥n.
        </p>
      </div>

      <div class="guide-step-card">
        <div class="guide-step-header">
          <div class="guide-step-number">6</div>
          <div class="guide-step-title">‚úÖ ¬°Listo! Tu n√∫mero est√° activo</div>
        </div>
        <p class="guide-step-text">
          Si seguiste el paso 3 correctamente (seleccionando el portfolio de KDS), 
          tu n√∫mero estar√° activo de inmediato y podr√°s comenzar a recibir pedidos.
        </p>
      </div>

      <button class="btn-close-guide" onclick="closePortfolioGuideModal()">
        Entendido, continuar con la conexi√≥n
      </button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <!-- Configuraci√≥n de Firebase -->
  <script src="config.js"></script>

  <!-- Auth Check -->
  <script>
    // Verificar que el usuario est√© autenticado
    const currentUserId = localStorage.getItem('currentUserId');
    if (!currentUserId) {
      // Redirigir a login si no est√° autenticado
      window.location.href = '/auth.html';
    }
  </script>

  <!-- Configuraci√≥n de Facebook -->
  <script src="facebook-config.js"></script>

  <!-- Facebook SDK for JavaScript -->
  <script>
    // Configuraci√≥n global antes de cargar el SDK
    window.fbAsyncInit = function() {
      FB.init({
        appId      : facebookConfig.appId,
        cookie     : facebookConfig.cookie,
        xfbml      : facebookConfig.xfbml,
        version    : facebookConfig.apiVersion
      });
      
      // Log de p√°gina vista (opcional, para analytics)
      if (facebookConfig.enableAnalytics) {
        FB.AppEvents.logPageView();
      }
      
      console.log('‚úÖ Facebook SDK inicializado correctamente');
      console.log('üì± App ID:', facebookConfig.appId);
      console.log('üîß API Version:', facebookConfig.apiVersion);
    };

    // Cargar el SDK de forma as√≠ncrona
    (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = `https://connect.facebook.net/${facebookConfig.locale}/sdk.js`;
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
  </script>

  <!-- L√≥gica de Embedded Signup -->
  <script>
    const btnConnect = document.getElementById('btn-connect');
    const loadingState = document.getElementById('loading-state');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const optionCards = document.querySelectorAll('.option-card');
    const migrationWarning = document.getElementById('migration-warning');
    const helpModal = document.getElementById('help-modal');
    const portfolioGuideModal = document.getElementById('portfolio-guide-modal');
    
    let selectedOption = null; // 'migrate' o 'new'

    // ====================================
    // FUNCIONES PARA MODALES
    // ====================================
    
    // Modal de ayuda (n√∫mero registrado)
    function showHelpModal() {
      helpModal.classList.add('active');
    }

    function closeHelpModal() {
      helpModal.classList.remove('active');
    }

    // Modal de gu√≠a de portfolio
    function showPortfolioGuideModal() {
      portfolioGuideModal.classList.add('active');
    }

    function closePortfolioGuideModal() {
      portfolioGuideModal.classList.remove('active');
    }

    // Cerrar modales al hacer clic fuera
    helpModal.addEventListener('click', function(e) {
      if (e.target === helpModal) {
        closeHelpModal();
      }
    });

    portfolioGuideModal.addEventListener('click', function(e) {
      if (e.target === portfolioGuideModal) {
        closePortfolioGuideModal();
      }
    });

    // Hacer las funciones accesibles globalmente
    window.closeHelpModal = closeHelpModal;
    window.showPortfolioGuideModal = showPortfolioGuideModal;
    window.closePortfolioGuideModal = closePortfolioGuideModal;

    // Manejo de selecci√≥n de opciones
    optionCards.forEach(card => {
      card.addEventListener('click', function() {
        // Remover selecci√≥n anterior
        optionCards.forEach(c => c.classList.remove('selected'));
        
        // Marcar como seleccionada
        this.classList.add('selected');
        
        // Guardar opci√≥n seleccionada
        selectedOption = this.getAttribute('data-option');
        
        // Mostrar/ocultar advertencia
        if (selectedOption === 'migrate') {
          migrationWarning.style.display = 'block';
        } else {
          migrationWarning.style.display = 'none';
        }
        
        // Habilitar bot√≥n
        btnConnect.disabled = false;
        
        console.log('üìå Opci√≥n seleccionada:', selectedOption);
      });
    });

    // Funci√≥n para mostrar error
    function showError(message) {
      errorText.textContent = message;
      errorMessage.classList.add('active');
      loadingState.classList.remove('active');
      btnConnect.disabled = false;
      const icon = btnConnect.querySelector('.whatsapp-icon');
      btnConnect.innerHTML = '';
      btnConnect.appendChild(icon);
      btnConnect.appendChild(document.createTextNode('Reintentar conexi√≥n'));
      
      // Si el error es de n√∫mero registrado, mostrar modal de ayuda autom√°ticamente
      if (message.toLowerCase().includes('registered') || 
          message.toLowerCase().includes('registrado') ||
          message.toLowerCase().includes('existing account')) {
        setTimeout(() => {
          showHelpModal();
        }, 1500);
      }
    }

    // Funci√≥n para ocultar error
    function hideError() {
      errorMessage.classList.remove('active');
    }

    // Evento del bot√≥n de conexi√≥n
    btnConnect.addEventListener('click', function() {
      if (!selectedOption) {
        showError('Por favor, selecciona una opci√≥n antes de continuar.');
        return;
      }

      hideError();
      btnConnect.disabled = true;
      loadingState.classList.add('active');

      // Verificar que FB est√© disponible
      if (typeof FB === 'undefined') {
        showError('Error cargando Facebook SDK. Por favor, recarga la p√°gina.');
        return;
      }

      console.log('üîÑ Iniciando flujo de Embedded Signup...');
      console.log('üìå Modo seleccionado:', selectedOption);

      // Lanzar el flujo de Facebook Login con Embedded Signup
      FB.login(function(response) {
        console.log('üì© Respuesta de FB.login:', response);

        if (response.authResponse) {
          const code = response.authResponse.code;
          
          if (!code) {
            showError('No se recibi√≥ el c√≥digo de autorizaci√≥n. Intenta nuevamente.');
            return;
          }

          console.log('‚úÖ C√≥digo de autorizaci√≥n recibido:', code);
          
          // Redirigir al backend con el c√≥digo y la opci√≥n seleccionada
          window.location.href = `${facebookConfig.callbackUrl}?code=${code}&mode=${selectedOption}`;
          
        } else {
          console.log('‚ùå Usuario cancel√≥ o hubo un error en la autorizaci√≥n');
          showError('Autorizaci√≥n cancelada. Por favor, acepta los permisos para continuar.');
        }
      }, {
        config_id: facebookConfig.embeddedSignupConfigId,
        response_type: 'code',
        override_default_response_type: true,
        scope: 'whatsapp_business_management,whatsapp_business_messaging',
        auth_type: 'rerequest',
        extras: {
          setup: {
            // Pre-seleccionar el Business Portfolio verificado de KDS
            // Esto evita que el cliente tenga que seleccionar manualmente
            // y asegura activaci√≥n instant√°nea
            business: {
              id: '880566844730976'
            }
          },
          featureType: '',
          sessionInfoVersion: 3  // Actualizado a v3 seg√∫n documentaci√≥n
        }
      });
    });

    // Manejo de errores globales
    window.addEventListener('error', function(e) {
      console.error('‚ùå Error global:', e.message);
    });
  </script>

  <!-- Google Analytics (opcional) -->
  <script>
    // Si tienes Google Analytics, puedes agregar tracking aqu√≠
    console.log('üìä P√°gina de onboarding cargada');
  </script>
</body>
</html>
