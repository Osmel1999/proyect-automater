# ๐๏ธ Arquitectura del Sistema Dual

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         SISTEMA DUAL KDS                             โ
โ                    Dos Portfolios Simultรกneos                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                            FRONTEND                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ   onboarding.html        โ         โ   onboarding-2.html      โ
    โ   (PRINCIPAL)            โ         โ   (LEGACY)               โ
    โ                          โ         โ                          โ
    โ  Portfolio:              โ         โ  Portfolio:              โ
    โ  880566844730976         โ         โ  1473689432774278        โ
    โ                          โ         โ                          โ
    โ  โ Verificado           โ         โ  ๐ Backup               โ
    โ  โก Instantรกneo          โ         โ  ๐งช Pruebas              โ
    โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ         โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโ
               โ                                    โ
               โ facebook-config.js                 โ facebook-config-legacy.js
               โ                                    โ
               โโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
                                โ
                                โ dual-config.js (compartido)
                                โ
                                โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        CAPA DE ROUTING                               โ
โ                                                                      โ
โ  Detecta quรฉ configuraciรณn usar basรกndose en la URL                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                โ
                โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
                โ                               โ
                โผ                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Meta App Principal      โ   โ  Meta App Legacy         โ
โ                          โ   โ                          โ
โ  App ID:                 โ   โ  App ID:                 โ
โ  849706941272247         โ   โ  1860852208127086        โ
โ                          โ   โ                          โ
โ  Config ID:              โ   โ  Config ID:              โ
โ  849873494548110         โ   โ  1609237700430950        โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
             โ                              โ
             โ OAuth Code                   โ OAuth Code
             โ                              โ
             โผ                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                            BACKEND                                   โ
โ                      server/index.js                                 โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ                              โ
             โผ                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Endpoints Principales   โ   โ  Endpoints Legacy        โ
โ                          โ   โ                          โ
โ  GET /api/whatsapp/      โ   โ  GET /api/whatsapp/      โ
โ      callback            โ   โ      callback-legacy     โ
โ                          โ   โ                          โ
โ  POST /webhook/          โ   โ  POST /webhook/          โ
โ       whatsapp           โ   โ       whatsapp-legacy    โ
โ                          โ   โ                          โ
โ  GET /webhook/           โ   โ  GET /webhook/           โ
โ      whatsapp            โ   โ      whatsapp-legacy     โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
             โ                              โ
             โ  Token Exchange              โ  Token Exchange
             โ  Phone Number ID             โ  Phone Number ID
             โ  Registration                โ  Registration
             โ                              โ
             โโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโ
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     FIREBASE REALTIME DATABASE                       โ
โ                                                                      โ
โ  tenants/                                                            โ
โ    โโโ tenant_abc123/                                                โ
โ    โ   โโโ configType: "primary"                                    โ
โ    โ   โโโ portfolioId: "880566844730976"                           โ
โ    โ   โโโ whatsappPhoneNumberId: "..."                             โ
โ    โ   โโโ ...                                                       โ
โ    โ                                                                 โ
โ    โโโ tenant_xyz789/                                                โ
โ        โโโ configType: "legacy"                                     โ
โ        โโโ portfolioId: "1473689432774278"                          โ
โ        โโโ whatsappPhoneNumberId: "..."                             โ
โ        โโโ ...                                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โ Mensajes entrantes
                             โ
                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     WHATSAPP BUSINESS API                            โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโ         โ
โ  โ Portfolio Principalโ              โ Portfolio Legacy   โ         โ
โ  โ 880566844730976    โ              โ 1473689432774278   โ         โ
โ  โ                    โ              โ                    โ         โ
โ  โ โข Nรบmeros activos  โ              โ โข Nรบmeros activos  โ         โ
โ  โ โข Mensajerรญa       โ              โ โข Mensajerรญa       โ         โ
โ  โ โข Estado de cuenta โ              โ โข Estado de cuenta โ         โ
โ  โโโโโโโโโโโโโโโโโโโโโโ              โโโโโโโโโโโโโโโโโโโโโโ         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


FLUJO DE ONBOARDING
โโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโ
โ   Usuario   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ Elige URL
       โ
       โโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
       โ                         โ                         โ
       โผ                         โผ                         โ
 onboarding.html           onboarding-2.html              โ
 (Principal)               (Legacy)                       โ
       โ                         โ                         โ
       โ Click "Conectar"        โ Click "Conectar"        โ
       โ                         โ                         โ
       โผ                         โผ                         โ
 Facebook OAuth           Facebook OAuth                  โ
 (App Principal)          (App Legacy)                    โ
       โ                         โ                         โ
       โ Pre-fill Portfolio      โ Pre-fill Portfolio      โ
       โ 880566844730976         โ 1473689432774278        โ
       โ                         โ                         โ
       โผ                         โผ                         โ
 Autorizaciรณn             Autorizaciรณn                    โ
       โ                         โ                         โ
       โ Redirect con code       โ Redirect con code       โ
       โ                         โ                         โ
       โผ                         โผ                         โ
 /api/whatsapp/callback   /api/whatsapp/callback-legacy  โ
       โ                         โ                         โ
       โ Exchange token          โ Exchange token          โ
       โ                         โ                         โ
       โผ                         โผ                         โ
 Crear tenant             Crear tenant                    โ
 configType: "primary"    configType: "legacy"            โ
       โ                         โ                         โ
       โโโโโโโโโโโโโโโฌโโโโโโโโโโโโ                         โ
                     โ                                     โ
                     โผ                                     โ
              onboarding-success.html                      โ
                     โ                                     โ
                     โ Tenant creado                       โ
                     โ Nรบmero registrado                   โ
                     โ                                     โ
                     โผ                                     โ
              ยกListo para recibir mensajes!               โ
                                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


VARIABLES DE ENTORNO
โโโโโโโโโโโโโโโโโโโ

Principal (Obligatorias):
โโโโโโโโโโโโโโโโโโโโโโโโ
WHATSAPP_APP_ID=849706941272247
WHATSAPP_APP_SECRET=<secret>
FACEBOOK_APP_ID=849706941272247
FACEBOOK_APP_SECRET=<secret>

Legacy (Opcionales):
โโโโโโโโโโโโโโโโโโโโ
WHATSAPP_APP_ID_LEGACY=1860852208127086
WHATSAPP_APP_SECRET_LEGACY=<secret>
FACEBOOK_APP_ID_LEGACY=1860852208127086
FACEBOOK_APP_SECRET_LEGACY=<secret>

Compartidas:
โโโโโโโโโโโโ
ENCRYPTION_KEY=<key>
FIREBASE_DATABASE_URL=<url>
FIREBASE_SERVICE_ACCOUNT_KEY=<base64>
BASE_URL=<railway_url>
WEBHOOK_VERIFY_TOKEN=<token>


IDENTIFICADORES VISUALES
โโโโโโโโโโโโโโโโโโโโโโโโ

Onboarding Principal:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  [Logo KDS]                          โ
โ                                      โ
โ  ๐ Conecta tu WhatsApp Business     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  Sin badge especial                  โ
โ  Fondo: Degradado azul/morado        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Onboarding Legacy:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ๐ Configuraciรณn LEGACY (Backup)    โ
โ  [Logo KDS]                          โ
โ                                      โ
โ  ๐ Conecta tu WhatsApp Business     โ
โ  Portfolio ID: 1473689432774278      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  Badge naranja destacado             โ
โ  Identificaciรณn clara de backup      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ


LOGS DEL SERVIDOR
โโโโโโโโโโโโโโโโ

Callback Principal:
โโโโโโโโโโโโโโโโโ
๐ฉ Callback recibido
   Portfolio: KDS
   Portfolio ID: 880566844730976
   App ID: 849706941272247
โ Access token obtenido exitosamente
๐ฑ Informaciรณn de WhatsApp obtenida
๐ Onboarding completado exitosamente!

Callback Legacy:
โโโโโโโโโโโโโโโ
๐ CALLBACK LEGACY recibido
   Portfolio: KDS Legacy
   Portfolio ID: 1473689432774278
   App ID: 1860852208127086
โ Access token obtenido exitosamente (LEGACY)
๐ฑ Informaciรณn de WhatsApp obtenida (LEGACY)
๐ Onboarding LEGACY completado exitosamente!


VENTAJAS DEL SISTEMA DUAL
โโโโโโโโโโโโโโโโโโโโโโโโโ

โ Flexibilidad
   - Dos configuraciones activas simultรกneamente
   - Sin necesidad de apagar una para usar la otra

โ Backup Automรกtico
   - Si un portfolio tiene problemas, usa el otro
   - Continuidad del servicio garantizada

โ Testing Seguro
   - Prueba cambios en legacy sin afectar producciรณn
   - Rollback instantรกneo si algo falla

โ Identificaciรณn Clara
   - Logs diferenciados
   - Base de datos con identificadores
   - Frontend con badges visuales

โ Independencia
   - Cada configuraciรณn funciona por separado
   - Sin interferencias entre portfolios
   - Webhooks y callbacks separados

โ Escalabilidad
   - Fรกcil agregar mรกs configuraciones
   - Sistema modular y extensible
   - Cรณdigo reutilizable
