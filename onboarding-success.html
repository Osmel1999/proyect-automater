<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>¬°Conexi√≥n Exitosa! - KDS Platform</title>
  <meta name="description" content="Tu WhatsApp Business ha sido conectado exitosamente">
  <link rel="icon" type="image/png" href="assets/images/kds-logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .success-container {
      max-width: 700px;
      width: 100%;
      padding: 50px 40px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: slideUp 0.6s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-icon {
      font-size: 100px;
      margin-bottom: 20px;
      animation: bounceIn 0.8s ease;
    }

    @keyframes bounceIn {
      0% { 
        transform: scale(0);
        opacity: 0;
      }
      50% { 
        transform: scale(1.2);
      }
      100% { 
        transform: scale(1);
        opacity: 1;
      }
    }

    .success-title {
      font-size: 36px;
      font-weight: 700;
      color: #25D366;
      margin-bottom: 16px;
      line-height: 1.2;
    }

    .success-subtitle {
      font-size: 18px;
      color: #4a5568;
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .tenant-info {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 40px;
      text-align: left;
      border: 2px solid #e2e8f0;
    }

    .tenant-info-title {
      font-size: 18px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 20px;
      text-align: center;
    }

    .tenant-info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #cbd5e0;
    }

    .tenant-info-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .tenant-info-label {
      font-weight: 600;
      color: #4a5568;
      font-size: 14px;
    }

    .tenant-info-value {
      color: #1a202c;
      font-weight: 500;
      font-size: 14px;
      word-break: break-all;
    }

    .tenant-info-value.loading {
      color: #a0aec0;
      font-style: italic;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #c6f6d5;
      color: #22543d;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .btn-dashboard {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 40px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-dashboard:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }

    .next-steps {
      margin-top: 50px;
      padding-top: 40px;
      border-top: 2px solid #e2e8f0;
    }

    .next-steps-title {
      font-size: 22px;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 24px;
    }

    .steps-list {
      text-align: left;
      max-width: 500px;
      margin: 0 auto;
      counter-reset: step-counter;
    }

    .step-item {
      position: relative;
      padding-left: 50px;
      margin-bottom: 20px;
      counter-increment: step-counter;
    }

    .step-item::before {
      content: counter(step-counter);
      position: absolute;
      left: 0;
      top: 0;
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
    }

    .step-item-title {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
      margin-bottom: 4px;
    }

    .step-item-desc {
      color: #718096;
      font-size: 14px;
      line-height: 1.5;
    }

    .help-text {
      margin-top: 40px;
      padding: 20px;
      background: #ebf8ff;
      border-left: 4px solid #3182ce;
      border-radius: 8px;
      font-size: 14px;
      color: #2c5282;
      text-align: left;
    }

    .help-text strong {
      display: block;
      margin-bottom: 8px;
      font-size: 15px;
    }

    /* Responsive */
    @media (max-width: 640px) {
      .success-container {
        padding: 40px 24px;
      }

      .success-title {
        font-size: 28px;
      }

      .tenant-info {
        padding: 20px;
      }

      .btn-dashboard {
        padding: 16px 32px;
        font-size: 16px;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="success-container">
    <div class="success-icon">üéâ</div>

    <h1 class="success-title" id="success-title">¬°WhatsApp Conectado!</h1>

    <p class="success-subtitle" id="success-subtitle">
      Tu n√∫mero de WhatsApp Business ha sido conectado exitosamente a la plataforma KDS. 
      Ahora puedes empezar a recibir pedidos autom√°ticamente.
    </p>

    <!-- Mensaje especial para migraci√≥n -->
    <div class="tenant-info" id="migration-note" style="display: none; background: #fff3cd; border-color: #ffc107;">
      <h3 class="tenant-info-title" style="color: #856404;">‚ö†Ô∏è Importante sobre tu migraci√≥n</h3>
      <p style="color: #856404; text-align: left; line-height: 1.6;">
        <strong>Tu n√∫mero fue migrado exitosamente.</strong><br><br>
        ‚Ä¢ La app de WhatsApp Business en tu tel√©fono ya no funciona<br>
        ‚Ä¢ Gestiona todos los pedidos desde el Panel KDS<br>
        ‚Ä¢ Tus clientes pueden seguir escribiendo al mismo n√∫mero que conocen<br>
        ‚Ä¢ Todas tus conversaciones previas est√°n preservadas
      </p>
    </div>

    <!-- Mensaje especial para n√∫mero nuevo -->
    <div class="tenant-info" id="new-number-note" style="display: none; background: #d1ecf1; border-color: #bee5eb;">
      <h3 class="tenant-info-title" style="color: #0c5460;">‚ú® Tu nuevo n√∫mero est√° activo</h3>
      <p style="color: #0c5460; text-align: left; line-height: 1.6;">
        <strong>¬°Tu n√∫mero nuevo de WhatsApp Business est√° listo!</strong><br><br>
        ‚Ä¢ Comparte tu n√∫mero con tus clientes<br>
        ‚Ä¢ Actualiza tus redes sociales y sitio web<br>
        ‚Ä¢ Pon avisos en tu local con el nuevo contacto<br>
        ‚Ä¢ Considera una fase de transici√≥n si ten√≠as otro n√∫mero activo
      </p>
    </div>

    <div class="tenant-info">
      <h3 class="tenant-info-title">üìã Informaci√≥n de tu cuenta</h3>

      <div class="tenant-info-item">
        <span class="tenant-info-label">ID de Cliente:</span>
        <span class="tenant-info-value" id="tenant-id">Cargando...</span>
      </div>

      <div class="tenant-info-item">
        <span class="tenant-info-label">Nombre del Negocio:</span>
        <span class="tenant-info-value loading" id="tenant-name">Cargando...</span>
      </div>

      <div class="tenant-info-item">
        <span class="tenant-info-label">Email:</span>
        <span class="tenant-info-value loading" id="tenant-email">Cargando...</span>
      </div>

      <div class="tenant-info-item">
        <span class="tenant-info-label">Estado:</span>
        <span class="status-badge">
          <span>‚úÖ</span>
          <span>Activo</span>
        </span>
      </div>

      <div class="tenant-info-item">
        <span class="tenant-info-label">Fecha de Registro:</span>
        <span class="tenant-info-value" id="tenant-date">Cargando...</span>
      </div>
    </div>

    <a href="home.html" class="btn-dashboard" id="btn-dashboard">
      Ir al Dashboard üöÄ
    </a>

    <div class="next-steps">
      <h3 class="next-steps-title">üéØ Pr√≥ximos pasos</h3>

      <div class="steps-list" id="steps-list">
        <div class="step-item">
          <div class="step-item-title">Configura tu men√∫</div>
          <div class="step-item-desc">
            Agrega tus productos, precios y categor√≠as para que el bot pueda mostrarlos a tus clientes.
          </div>
        </div>

        <div class="step-item">
          <div class="step-item-title">Personaliza los mensajes</div>
          <div class="step-item-desc">
            Ajusta los mensajes de bienvenida, despedida y confirmaci√≥n seg√∫n tu marca.
          </div>
        </div>

        <div class="step-item">
          <div class="step-item-title">Prueba el bot</div>
          <div class="step-item-desc">
            Env√≠a un mensaje a tu n√∫mero de WhatsApp para probar que todo funciona correctamente.
          </div>
        </div>

        <div class="step-item">
          <div class="step-item-title">¬°Empieza a recibir pedidos!</div>
          <div class="step-item-desc">
            Comparte tu n√∫mero de WhatsApp con tus clientes y comienza a automatizar tus ventas.
          </div>
        </div>
      </div>
    </div>

    <div class="help-text">
      <strong>üí° ¬øNecesitas ayuda?</strong>
      Si tienes alguna pregunta o problema con la configuraci√≥n, 
      cont√°ctanos en <strong>soporte@kingdomdesignpro.com</strong> o 
      visita nuestra secci√≥n de ayuda en el dashboard.
    </div>
  </div>

  <script>
    // Obtener tenant ID y modo de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const tenantId = urlParams.get('tenantId') || urlParams.get('tenant');
    const mode = urlParams.get('mode');

    // Elementos del DOM
    const successTitle = document.getElementById('success-title');
    const successSubtitle = document.getElementById('success-subtitle');
    const migrationNote = document.getElementById('migration-note');
    const newNumberNote = document.getElementById('new-number-note');
    const tenantIdElement = document.getElementById('tenant-id');
    const tenantNameElement = document.getElementById('tenant-name');
    const tenantEmailElement = document.getElementById('tenant-email');
    const tenantDateElement = document.getElementById('tenant-date');
    const btnDashboard = document.getElementById('btn-dashboard');

    // Personalizar mensaje seg√∫n el modo
    if (mode === 'migrate') {
      successTitle.textContent = 'üîÑ ¬°Migraci√≥n Exitosa!';
      successSubtitle.textContent = 'Tu n√∫mero de WhatsApp Business fue migrado correctamente. Tus clientes pueden seguir escribiendo al mismo n√∫mero que conocen.';
      migrationNote.style.display = 'block';
    } else if (mode === 'new') {
      successTitle.textContent = '‚ú® ¬°N√∫mero Registrado!';
      successSubtitle.textContent = 'Tu nuevo n√∫mero de WhatsApp Business est√° activo. No olvides compartirlo con tus clientes.';
      newNumberNote.style.display = 'block';
    }

    if (tenantId) {
      // Mostrar ID inmediatamente
      tenantIdElement.textContent = tenantId;
      tenantIdElement.classList.remove('loading');

      // Actualizar link del dashboard con el tenant ID
      btnDashboard.href = `dashboard.html?tenant=${tenantId}`;

      // Cargar informaci√≥n del tenant desde el backend (Railway)
      const backendUrl = 'https://api.kdsapp.site';
      
      fetch(`${backendUrl}/api/tenant/${tenantId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('No se pudo cargar la informaci√≥n del tenant');
          }
          return response.json();
        })
        .then(data => {
          console.log('‚úÖ Datos del tenant cargados:', data);

          // Verificar si la estructura es de tenant service
          const tenant = data.tenant || data;

          // Actualizar nombre
          if (tenant.restaurant && tenant.restaurant.name) {
            tenantNameElement.textContent = tenant.restaurant.name;
            tenantNameElement.classList.remove('loading');
          }

          // Actualizar email (puede no existir)
          if (tenant.restaurant && tenant.restaurant.ownerEmail) {
            tenantEmailElement.textContent = tenant.restaurant.ownerEmail;
            tenantEmailElement.classList.remove('loading');
          } else {
            tenantEmailElement.textContent = 'No configurado';
            tenantEmailElement.classList.remove('loading');
          }

          // Actualizar fecha de registro
          if (tenant.createdAt) {
            const fecha = new Date(tenant.createdAt);
            const fechaFormateada = fecha.toLocaleDateString('es-ES', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            tenantDateElement.textContent = fechaFormateada;
            tenantDateElement.classList.remove('loading');
          }
        })
        .catch(error => {
          console.error('‚ùå Error cargando informaci√≥n del tenant:', error);
          
          // Mostrar valores por defecto en caso de error
          tenantNameElement.textContent = 'Mi Restaurante';
          tenantNameElement.classList.remove('loading');
          
          tenantEmailElement.textContent = 'No configurado';
          tenantEmailElement.classList.remove('loading');
          
          tenantDateElement.textContent = new Date().toLocaleDateString('es-ES');
          tenantDateElement.classList.remove('loading');
        });
    } else {
      // Si no hay tenant ID, mostrar error
      tenantIdElement.textContent = 'Error: No se recibi√≥ ID';
      tenantNameElement.textContent = 'Error en la conexi√≥n';
      tenantEmailElement.textContent = 'Error en la conexi√≥n';
      tenantDateElement.textContent = '-';
      
      tenantIdElement.style.color = '#e53e3e';
      tenantNameElement.style.color = '#e53e3e';
      tenantEmailElement.style.color = '#e53e3e';
    }

    // Analytics: registrar evento de onboarding exitoso
    console.log('‚úÖ Onboarding completado para tenant:', tenantId);

    // Actualizar usuario en Firebase con el tenantId y marcar onboarding completado
    const currentUserId = localStorage.getItem('currentUserId');
    if (currentUserId && tenantId) {
      // Necesitamos cargar Firebase primero
      const updateUserScript = document.createElement('script');
      updateUserScript.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js';
      updateUserScript.onload = function() {
        const dbScript = document.createElement('script');
        dbScript.src = 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js';
        dbScript.onload = function() {
          const configScript = document.createElement('script');
          configScript.src = 'config.js';
          configScript.onload = function() {
            // Ahora actualizar el usuario
            firebase.database().ref('users/' + currentUserId).update({
              tenantId: tenantId,
              onboardingCompleted: true,
              whatsappConnected: true
            }).then(() => {
              console.log('‚úÖ Usuario actualizado con tenantId:', tenantId);
              localStorage.setItem('currentTenantId', tenantId);
            }).catch(error => {
              console.error('‚ùå Error actualizando usuario:', error);
            });
          };
          document.head.appendChild(configScript);
        };
        document.head.appendChild(dbScript);
      };
      document.head.appendChild(updateUserScript);
    }
  </script>
  
  <script>
    // Cambiar el href del dashboard para redirigir a la p√°gina de selecci√≥n
    document.addEventListener('DOMContentLoaded', function() {
      const btnDashboard = document.getElementById('btn-dashboard');
      if (btnDashboard) {
        btnDashboard.addEventListener('click', function(e) {
          e.preventDefault();
          window.location.href = '/select.html';
        });
      }
    });
  </script>
</body>
</html>
