<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecciona una Opci√≥n - KDS App</title>
    <!-- Version: 3.0.0 - Modern Design - 2026-01-30 -->
    <link rel="stylesheet" href="css/select-modern.css">
    <link rel="stylesheet" href="css/animations.css">
</head>
<body>
    <div class="select-container animate-fade-in">
        <div class="select-header animate-fade-in-down">
            <div class="header-icon animate-float">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </div>
            <h1>Bienvenido a KDS App</h1>
            <p>¬øQu√© deseas hacer hoy?</p>
            
            <div class="user-info">
                <div class="user-info-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </div>
                <div class="user-info-text">
                    <div class="user-info-name" id="userName">Cargando...</div>
                    <div class="user-info-business" id="businessName">Cargando...</div>
                </div>
            </div>
            
            <!-- Membership Status Badge -->
            <div class="membership-status-badge" id="membershipBadge">
                <div class="membership-badge-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </div>
                <span class="membership-badge-text" id="membershipText">Cargando...</span>
            </div>
        </div>

        <div class="select-body">
            <div class="options-grid">
                <div class="option-card card-animated delay-100 hover-lift" id="kdsOption">
                    <div class="option-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                            <polyline points="17 2 12 7 7 2"></polyline>
                        </svg>
                    </div>
                    <div class="option-title">KDS</div>
                    <div class="option-description">
                        Ver y gestionar pedidos en tiempo real
                    </div>
                </div>

                <div class="option-card card-animated delay-300 hover-lift" id="dashboardOption">
                    <div class="lock-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                    <div class="option-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </div>
                    <div class="option-title">Dashboard</div>
                    <div id="onboardingBadge" class="option-badge">Completar configuraci√≥n</div>
                    <div class="option-description">
                        Configurar men√∫, mensajes y bot de WhatsApp
                    </div>
                </div>
            </div>

            <button class="logout-button animate-fade-in-up delay-500 hover-scale" id="logoutBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="pin-modal" id="pinModal">
        <div class="pin-modal-content">
            <div class="pin-modal-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
            </div>
            <div class="pin-modal-title">Ingresa tu PIN</div>
            <div class="pin-modal-description">
                Ingresa tu PIN de 4 d√≠gitos para acceder al Dashboard
            </div>

            <div class="pin-input-group">
                <input type="password" class="pin-digit" maxlength="1" pattern="[0-9]">
                <input type="password" class="pin-digit" maxlength="1" pattern="[0-9]">
                <input type="password" class="pin-digit" maxlength="1" pattern="[0-9]">
                <input type="password" class="pin-digit" maxlength="1" pattern="[0-9]">
            </div>

            <div class="pin-error" id="pinError">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                </svg>
                PIN incorrecto. Intenta nuevamente.
            </div>

            <div class="pin-buttons">
                <button class="pin-btn pin-btn-cancel" id="pinCancelBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Cancelar
                </button>
                <button class="pin-btn pin-btn-verify" id="pinVerifyBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Verificar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Trial Expirado -->
    <div class="membership-modal" id="membershipModal">
        <div class="membership-modal-content">
            <div class="membership-modal-icon expired">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="membership-modal-title">Tu per√≠odo de prueba ha terminado</div>
            <div class="membership-modal-description">
                Han pasado 30 d√≠as desde que comenzaste tu prueba gratuita. 
                Para seguir usando KDS App y tu bot de WhatsApp, elige un plan que se adapte a tu negocio.
            </div>
            <div class="membership-plans-summary">
                <div class="plan-option">
                    <span class="plan-name">Emprendedor</span>
                    <span class="plan-price">$90.000/mes</span>
                </div>
                <div class="plan-option">
                    <span class="plan-name">Profesional</span>
                    <span class="plan-price">$120.000/mes</span>
                </div>
                <div class="plan-option featured">
                    <span class="plan-name">Empresarial</span>
                    <span class="plan-price">$150.000/mes</span>
                </div>
            </div>
            <div class="membership-modal-buttons">
                <a href="/index.html#pricing" class="membership-btn primary">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Ver Planes y Precios
                </a>
                <button class="membership-btn secondary" id="contactSupportBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    Contactar Soporte
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- Configuraci√≥n de Firebase -->
    <script src="config.js"></script>

    <script>
        // Check authentication
        const currentUserId = localStorage.getItem('currentUserId');
        const currentTenantId = localStorage.getItem('currentTenantId');

        // Initialize Firebase early for status checks
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        if (!currentUserId) {
            window.location.href = '/auth.html';
        }

        // ===== MEMBERSHIP VERIFICATION =====
        async function checkMembershipStatus() {
            if (!currentTenantId) return { valid: false, reason: 'no_tenant' };
            
            try {
                // Verificar si ya hay datos de membres√≠a en localStorage
                const membershipPlan = localStorage.getItem('membershipPlan');
                const membershipStatus = localStorage.getItem('membershipStatus');
                const membershipDaysLeft = parseInt(localStorage.getItem('membershipDaysLeft') || '0');
                
                // Obtener datos frescos de Firebase
                const snapshot = await firebase.database().ref(`tenants/${currentTenantId}/membership`).once('value');
                const membership = snapshot.val();
                
                if (!membership) {
                    // Si no hay membres√≠a, asumimos trial expirado (caso legacy)
                    console.warn('‚ö†Ô∏è No se encontr√≥ informaci√≥n de membres√≠a');
                    return { valid: false, reason: 'no_membership', expired: true };
                }
                
                const now = Date.now();
                const plan = membership.plan || 'trial';
                const status = membership.status || 'active';
                
                // Verificar si es trial y si expir√≥
                if (plan === 'trial') {
                    const trialEnd = membership.trialEndDate;
                    if (trialEnd && now > trialEnd) {
                        // Trial expirado
                        console.log('‚è∞ Trial expirado');
                        return { 
                            valid: false, 
                            reason: 'trial_expired',
                            expired: true,
                            plan: 'trial',
                            daysLeft: 0
                        };
                    } else if (trialEnd) {
                        // Trial activo
                        const daysLeft = Math.ceil((trialEnd - now) / (1000 * 60 * 60 * 24));
                        console.log(`‚úÖ Trial activo - ${daysLeft} d√≠as restantes`);
                        return {
                            valid: true,
                            plan: 'trial',
                            daysLeft: daysLeft,
                            status: 'active'
                        };
                    }
                }
                
                // Si es plan de pago, verificar status
                if (status === 'active' || status === 'paid') {
                    console.log(`‚úÖ Plan ${plan} activo`);
                    return {
                        valid: true,
                        plan: plan,
                        status: status
                    };
                }
                
                // Plan inactivo/suspendido
                return {
                    valid: false,
                    reason: 'subscription_inactive',
                    plan: plan,
                    status: status
                };
                
            } catch (error) {
                console.error('Error verificando membres√≠a:', error);
                // En caso de error, permitir acceso pero loguear
                return { valid: true, error: true };
            }
        }
        
        function showMembershipModal() {
            const modal = document.getElementById('membershipModal');
            if (modal) {
                modal.classList.add('active');
                // Deshabilitar interacci√≥n con el resto de la p√°gina
                document.body.style.overflow = 'hidden';
            }
        }
        
        function updateMembershipBadge(membershipData) {
            const badge = document.getElementById('membershipBadge');
            const text = document.getElementById('membershipText');
            
            if (!badge || !text) return;
            
            badge.classList.remove('trial', 'active', 'expired', 'warning');
            
            if (!membershipData.valid) {
                badge.classList.add('expired');
                text.textContent = 'Trial Expirado';
            } else if (membershipData.plan === 'trial') {
                if (membershipData.daysLeft <= 5) {
                    badge.classList.add('warning');
                    text.textContent = `Trial: ${membershipData.daysLeft} d√≠as`;
                } else {
                    badge.classList.add('trial');
                    text.textContent = `Trial: ${membershipData.daysLeft} d√≠as`;
                }
            } else {
                badge.classList.add('active');
                const planNames = {
                    'emprendedor': 'Emprendedor',
                    'profesional': 'Profesional',
                    'empresarial': 'Empresarial'
                };
                text.textContent = `Plan ${planNames[membershipData.plan] || membershipData.plan}`;
            }
        }
        
        // Ejecutar verificaci√≥n de membres√≠a al cargar
        async function initMembershipCheck() {
            const membershipData = await checkMembershipStatus();
            
            updateMembershipBadge(membershipData);
            
            if (!membershipData.valid && membershipData.expired) {
                // Mostrar modal de trial expirado
                showMembershipModal();
            }
        }
        
        // Iniciar verificaci√≥n
        initMembershipCheck();

        // Check onboarding status and update UI
        async function checkOnboardingStatus() {
            if (!currentTenantId) return;
            
            try {
                const snapshot = await firebase.database().ref(`tenants/${currentTenantId}/onboarding/steps`).once('value');
                const steps = snapshot.val() || {};
                
                // Solo verificar los 3 pasos cr√≠ticos (igual que en dashboard.html)
                const whatsappConnected = steps.whatsapp_connected || false;
                const menuConfigured = steps.menu_configured || false;
                const messagesCustomized = steps.messages_customized || false;
                
                // Contar pasos completados
                const criticalSteps = [whatsappConnected, menuConfigured, messagesCustomized];
                const completedSteps = criticalSteps.filter(s => s === true).length;
                const allComplete = completedSteps === 3;
                
                console.log(`üîç Estado del onboarding:
                  - WhatsApp: ${whatsappConnected}
                  - Men√∫: ${menuConfigured}
                  - Mensajes: ${messagesCustomized}
                  - Completo: ${allComplete}`);
                
                const onboardingBadge = document.getElementById('onboardingBadge');
                
                if (!allComplete) {
                    onboardingBadge.style.display = 'inline-block';
                    onboardingBadge.textContent = 'Completar configuraci√≥n';
                } else {
                    onboardingBadge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking onboarding status:', error);
            }
        }

        // Load user data
        const userName = localStorage.getItem('userName') || 'Usuario';
        const businessName = localStorage.getItem('businessName') || 'Mi Negocio';

        document.getElementById('userName').textContent = userName;
        document.getElementById('businessName').textContent = businessName;

        // Run onboarding check
        checkOnboardingStatus();

        // PIN Modal functionality
        const pinModal = document.getElementById('pinModal');
        const pinDigits = document.querySelectorAll('.pin-digit');
        const pinError = document.getElementById('pinError');
        const pinCancelBtn = document.getElementById('pinCancelBtn');
        const pinVerifyBtn = document.getElementById('pinVerifyBtn');

        // PIN input handling
        pinDigits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < pinDigits.length - 1) {
                    pinDigits[index + 1].focus();
                }
            });

            digit.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    pinDigits[index - 1].focus();
                }
            });
        });

        function showPinModal() {
            pinModal.classList.add('active');
            pinDigits[0].focus();
        }

        function closePinModal() {
            pinModal.classList.remove('active');
            pinDigits.forEach(d => {
                d.value = '';
                d.classList.remove('error');
            });
            pinError.classList.remove('show');
        }

        function getPin() {
            return Array.from(pinDigits).map(d => d.value).join('');
        }

        async function hashPin(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function verifyPin() {
            const pin = getPin();
            
            if (pin.length !== 4) {
                return;
            }

            try {
                // Get user PIN from database
                const userSnapshot = await firebase.database().ref('users/' + currentUserId).once('value');
                const userData = userSnapshot.val();

                if (!userData) {
                    throw new Error('Usuario no encontrado');
                }

                // Hash entered PIN and compare
                const hashedPin = await hashPin(pin);

                if (hashedPin === userData.pin) {
                    // PIN correct, redirect to dashboard directly
                    // NEVER redirect to onboarding from here - onboarding is only for initial setup
                    closePinModal();
                    window.location.href = `/dashboard.html?tenant=${currentTenantId}`;
                } else {
                    // PIN incorrect
                    pinError.classList.add('show');
                    pinDigits.forEach(d => {
                        d.classList.add('error');
                        d.value = '';
                    });
                    pinDigits[0].focus();

                    setTimeout(() => {
                        pinDigits.forEach(d => d.classList.remove('error'));
                    }, 500);
                }
            } catch (error) {
                console.error('Error verificando PIN:', error);
                alert('Error al verificar el PIN. Intenta nuevamente.');
            }
        }

        // Event listeners
        document.getElementById('kdsOption').addEventListener('click', () => {
            window.location.href = '/kds.html';
        });

        document.getElementById('dashboardOption').addEventListener('click', () => {
            showPinModal();
        });

        pinCancelBtn.addEventListener('click', closePinModal);
        pinVerifyBtn.addEventListener('click', verifyPin);

        // Enter key on PIN
        pinDigits.forEach((digit, index) => {
            digit.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && index === pinDigits.length - 1) {
                    verifyPin();
                }
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await firebase.auth().signOut();
                localStorage.clear();
                window.location.href = '/auth.html';
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('Error al cerrar sesi√≥n');
            }
        });
        
        // Contact Support button
        document.getElementById('contactSupportBtn')?.addEventListener('click', () => {
            window.open('https://wa.me/573001234567?text=Hola,%20mi%20trial%20de%20KDS%20App%20expir√≥%20y%20quiero%20informaci√≥n%20sobre%20los%20planes', '_blank');
        });
    </script>
</body>
</html>
