<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug - Onboarding Legacy</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #00ff00;
    }
    .log {
      margin: 10px 0;
      padding: 10px;
      background: #2a2a2a;
      border-left: 3px solid #00ff00;
    }
    .error {
      border-left-color: #ff0000;
      color: #ff0000;
    }
    .warning {
      border-left-color: #ffaa00;
      color: #ffaa00;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üîç DEBUG - Onboarding Legacy</h1>
  <p>Esta p√°gina muestra todos los detalles t√©cnicos del proceso</p>
  
  <div id="logs"></div>
  
  <button onclick="testConfig()">1. Test Configuraci√≥n</button>
  <button onclick="testFBSDK()">2. Test Facebook SDK</button>
  <button onclick="startOnboarding()">3. Iniciar Onboarding</button>
  <button onclick="clearLogs()">Limpiar Logs</button>

  <script src="facebook-config-legacy.js"></script>
  <script>
    function log(message, type = 'info') {
      const logsDiv = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.className = 'log ' + (type === 'error' ? 'error' : type === 'warning' ? 'warning' : '');
      logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.appendChild(logEntry);
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    function testConfig() {
      log('=== CONFIGURACI√ìN LEGACY ===');
      log(`App ID: ${facebookConfigLegacy.appId}`);
      log(`Config ID: ${facebookConfigLegacy.embeddedSignupConfigId}`);
      log(`Callback URL: ${facebookConfigLegacy.callbackUrl}`);
      log(`Portfolio ID: ${facebookConfigLegacy.portfolioId}`);
      log(`API Version: ${facebookConfigLegacy.apiVersion}`);
    }

    function testFBSDK() {
      log('=== FACEBOOK SDK ===');
      if (typeof FB === 'undefined') {
        log('‚ùå ERROR: Facebook SDK no est√° cargado', 'error');
        return;
      }
      log('‚úÖ Facebook SDK cargado correctamente');
      
      FB.getLoginStatus(function(response) {
        log('Estado de login: ' + response.status);
        if (response.status === 'connected') {
          log('‚úÖ Usuario ya conectado');
          log('User ID: ' + response.authResponse.userID);
        } else {
          log('‚ö†Ô∏è Usuario no conectado', 'warning');
        }
      });
    }

    function startOnboarding() {
      log('=== INICIANDO ONBOARDING ===');
      
      if (typeof FB === 'undefined') {
        log('‚ùå ERROR: Facebook SDK no disponible', 'error');
        return;
      }

      log('Llamando a FB.login...');
      log(`Config ID que se usar√°: ${facebookConfigLegacy.embeddedSignupConfigId}`);
      log(`Portfolio ID pre-seleccionado: ${facebookConfigLegacy.portfolioId}`);

      const loginOptions = {
        config_id: facebookConfigLegacy.embeddedSignupConfigId,
        response_type: 'code',
        override_default_response_type: true,
        scope: 'whatsapp_business_management,whatsapp_business_messaging',
        auth_type: 'rerequest',
        extras: {
          setup: {
            business: {
              id: facebookConfigLegacy.portfolioId
            }
          },
          featureType: '',
          sessionInfoVersion: 3
        }
      };

      log('Opciones de login: ' + JSON.stringify(loginOptions, null, 2));

      FB.login(function(response) {
        log('=== RESPUESTA DE FB.login ===');
        log(JSON.stringify(response, null, 2));

        if (response.authResponse) {
          log('‚úÖ Autorizaci√≥n exitosa');
          
          // Intentar obtener el c√≥digo de diferentes lugares
          let code = response.authResponse.code;
          
          // Si no est√° en authResponse.code, intentar decodificar signedRequest
          if (!code && response.authResponse.signedRequest) {
            log('‚ö†Ô∏è C√≥digo no encontrado en authResponse.code', 'warning');
            log('üîç Intentando extraer del signedRequest...');
            
            try {
              const signedRequest = response.authResponse.signedRequest;
              const payload = signedRequest.split('.')[1];
              const decodedPayload = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
              
              log('üì¶ signedRequest decodificado:');
              log(JSON.stringify(decodedPayload, null, 2));
              
              code = decodedPayload.code;
              
              if (code) {
                log('‚úÖ C√≥digo extra√≠do del signedRequest!');
              }
            } catch (e) {
              log('‚ùå ERROR al decodificar signedRequest: ' + e.message, 'error');
            }
          }
          
          if (code) {
            log(`‚úÖ C√≥digo recibido: ${code.substring(0, 20)}...`);
            log(`Redirigiendo a: ${facebookConfigLegacy.callbackUrl}`);
            
            const redirectUrl = `${facebookConfigLegacy.callbackUrl}?code=${code}&mode=new`;
            log(`URL completa: ${redirectUrl}`);
            
            // Esperar 2 segundos para que veas el log
            setTimeout(() => {
              window.location.href = redirectUrl;
            }, 2000);
          } else {
            log('‚ùå ERROR: No se recibi√≥ c√≥digo de autorizaci√≥n', 'error');
            log('‚ö†Ô∏è Intenta usar accessToken en su lugar', 'warning');
          }
        } else {
          log('‚ùå ERROR: No se recibi√≥ authResponse', 'error');
          log('Usuario cancel√≥ o hubo un error');
        }
      }, loginOptions);
    }

    // Cargar Facebook SDK
    log('Cargando Facebook SDK...');
    window.fbAsyncInit = function() {
      FB.init({
        appId: facebookConfigLegacy.appId,
        cookie: true,
        xfbml: true,
        version: facebookConfigLegacy.apiVersion
      });
      log('‚úÖ Facebook SDK inicializado');
      testFBSDK();
    };

    (function(d, s, id){
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) {return;}
      js = d.createElement(s); js.id = id;
      js.src = `https://connect.facebook.net/${facebookConfigLegacy.locale}/sdk.js`;
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    // Log inicial
    log('üöÄ P√°gina de debug cargada');
    log('Dominio actual: ' + window.location.origin);
    testConfig();
  </script>
</body>
</html>
