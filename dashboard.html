<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - KDS Platform</title>
  <meta name="description" content="Configuracion y gestion de tu restaurante">
  <link rel="icon" type="image/png" href="assets/images/kds-logo.png">
  
  <!-- Estilos externos -->
  <link rel="stylesheet" href="css/dashboard.css">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">KDS</div>
      <div class="tenant-name" id="tenant-name">Cargando...</div>
    </div>
    <div class="header-right">
      <!-- WhatsApp Status -->
      <div class="whatsapp-status disconnected" id="whatsapp-status" style="display: none;">
        <span class="status-dot disconnected" id="status-dot"></span>
        <span id="status-text">Desconectado</span>
      </div>
      
      <!-- Disconnect WhatsApp Button -->
      <button class="btn-disconnect" id="btn-disconnect-whatsapp" style="display: none;" onclick="disconnectWhatsApp()">
        Desconectar WhatsApp
      </button>
      
      <!-- Connect WhatsApp Button -->
      <button class="btn-connect" id="btn-connect-whatsapp" style="display: none;" onclick="connectWhatsApp()">
        Conectar WhatsApp
      </button>
      
      <a href="/kds.html" class="btn-secondary" id="kdsBtn">Ver KDS</a>
      <a href="/select.html" class="btn-secondary">Inicio</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div id="loading-container" class="loading">
      <div class="spinner"></div>
      <p>Cargando tu configuracion...</p>
    </div>

    <!-- Bot Control Card - Solo visible cuando onboarding esta completo -->
    <div id="bot-control-container" style="display: none;">
      <div class="bot-control-card" id="bot-control-card">
        <div class="bot-control-icon" id="bot-control-icon">Bot</div>
        <div class="bot-control-content">
          <div class="bot-control-title">Bot de WhatsApp</div>
          <div class="bot-control-status" id="bot-status-text">
            <span class="status-dot"></span>
            <span id="bot-status-label">Cargando...</span>
          </div>
        </div>
        <div class="bot-toggle-container">
          <div class="bot-toggle" id="bot-toggle" onclick="toggleBot()">
            <div class="bot-toggle-slider"></div>
          </div>
          <span class="bot-toggle-label" id="bot-toggle-label">OFF</span>
        </div>
      </div>
    </div>

    <!-- Wizard (hidden initially) -->
    <div id="wizard-container" style="display: none;">
      <div class="wizard-card">
        <div class="wizard-header">
          <h1 class="wizard-title">Bienvenido a KDS Platform!</h1>
          <p class="wizard-subtitle">Completa estos pasos para empezar a recibir pedidos automaticamente</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-text">
            <span class="progress-label">Tu progreso</span>
            <span class="progress-percentage" id="progress-percentage">25%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
          </div>
        </div>

        <!-- Steps -->
        <div class="steps">
          <!-- Step 1: WhatsApp -->
          <div class="step-item" id="step-1">
            <div class="step-icon">1</div>
            <div class="step-content">
              <div class="step-title">1. Conectar WhatsApp</div>
              <div class="step-description">Vincula tu numero de WhatsApp Business para recibir pedidos</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="connectWhatsAppStep()">Conectar</button>
            </div>
          </div>

          <!-- Step 2: Menu -->
          <div class="step-item" id="step-2">
            <div class="step-icon">2</div>
            <div class="step-content">
              <div class="step-title">2. Configurar tu menu</div>
              <div class="step-description">Agrega los productos que tus clientes pueden ordenar (5 min)</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="openMenuConfig()">Configurar</button>
            </div>
          </div>

          <!-- Step 3: Messages -->
          <div class="step-item" id="step-3">
            <div class="step-icon">3</div>
            <div class="step-content">
              <div class="step-title">3. Personalizar mensajes</div>
              <div class="step-description">Ajusta los mensajes automaticos que envia el bot (3 min)</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="openMessagesConfig()">Personalizar</button>
            </div>
          </div>

          <!-- Step 4: Activate Bot -->
          <div class="step-item" id="step-4">
            <div class="step-icon">4</div>
            <div class="step-content">
              <div class="step-title">4. Activar el bot</div>
              <div class="step-description">Enciende el bot para empezar a recibir pedidos automaticamente</div>
            </div>
            <div class="step-action">
              <button class="btn-step" id="activate-bot-btn" onclick="activateBotStep()" disabled>Activar</button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="wizard-footer">
          <button class="btn-skip" onclick="skipOnboarding()">Saltar por ahora, explorar por mi cuenta</button>
        </div>
      </div>
    </div>

    <!-- Completion Card / Dashboard (hidden initially) -->
    <div id="completion-container" style="display: none;">
      <div class="dashboard-main">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">Stats</div>
            <div class="stat-content">
              <div class="stat-label">Pedidos Hoy</div>
              <div class="stat-value" id="orders-today">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">$</div>
            <div class="stat-content">
              <div class="stat-label">Ventas Hoy</div>
              <div class="stat-value" id="sales-today">$0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">WA</div>
            <div class="stat-content">
              <div class="stat-label">WhatsApp</div>
              <div class="stat-value" id="whatsapp-status-main">Conectado</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
          <h2 class="section-title-main">Acciones Rapidas</h2>
          <div class="actions-grid">
            <div class="action-card" onclick="openMenuConfig()">
              <div class="action-icon">Menu</div>
              <h3>Gestionar Menu</h3>
              <p>Agregar, editar o eliminar productos de tu menu</p>
            </div>
            <div class="action-card" onclick="openMessagesConfig()">
              <div class="action-icon">Msg</div>
              <h3>Personalizar Mensajes</h3>
              <p>Editar mensajes automaticos del bot</p>
            </div>
            <div class="action-card" onclick="openPaymentConfig()">
              <div class="action-icon">Pay</div>
              <h3>Configurar Pagos</h3>
              <p>Activar pagos online con Wompi</p>
            </div>
            <div class="action-card" onclick="window.location.href='kds.html'">
              <div class="action-icon">KDS</div>
              <h3>Pantalla de Cocina</h3>
              <p>Ver pedidos en tiempo real (KDS)</p>
            </div>
            <div class="action-card" onclick="viewWhatsAppInfo()">
              <div class="action-icon">WA</div>
              <h3>Info WhatsApp</h3>
              <p>Ver numero y estado de conexion</p>
            </div>
            <div class="action-card" onclick="openDeliveryTimeConfig()">
              <div class="action-icon">Time</div>
              <h3>Tiempo de Entrega</h3>
              <p>Configurar tiempo estimado de entrega</p>
            </div>
          </div>
        </div>

        <!-- Menu Preview -->
        <div class="dashboard-section">
          <div class="section-header-main">
            <h2 class="section-title-main">Tu Menu</h2>
            <button class="btn-primary" onclick="openMenuConfig()">+ Agregar Producto</button>
          </div>
          <div id="menu-list-preview" class="menu-preview-grid">
            <p style="color: #718096;">Cargando menu...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Menu Config -->
  <div class="modal-overlay" id="menu-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Configurar Menu</h2>
        <button class="modal-close" onclick="closeMenuModal()">x</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Agrega los productos de tu menu. Los clientes podran ordenarlos por WhatsApp.
        </p>

        <div class="form-group">
          <label class="form-label">Nombre del producto</label>
          <input type="text" class="form-input" id="item-name" placeholder="Ej: Hamburguesa Clasica">
        </div>

        <div class="form-group">
          <label class="form-label">Precio (COP)</label>
          <input type="number" class="form-input" id="item-price" placeholder="25000">
        </div>

        <div class="form-group">
          <label class="form-label">Descripcion (opcional)</label>
          <input type="text" class="form-input" id="item-description" placeholder="Carne, lechuga, tomate...">
        </div>

        <div class="form-group">
          <label class="form-label">Categoria</label>
          <select class="form-select" id="item-category">
            <option value="Entradas">Entradas</option>
            <option value="Platos Principales">Platos Principales</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Postres">Postres</option>
          </select>
        </div>

        <button class="btn-add" onclick="addMenuItem()">+ Agregar producto</button>

        <div class="menu-items" id="menu-items-list">
          <!-- Items will be added here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeMenuModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveMenu()">Guardar Menu</button>
      </div>
    </div>
  </div>

  <!-- Modal: Messages Config -->
  <div class="modal-overlay" id="messages-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Personalizar Mensajes</h2>
        <button class="modal-close" onclick="closeMessagesModal()">x</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Personaliza los mensajes automaticos que envia el bot a tus clientes.
        </p>

        <div class="form-group">
          <label class="form-label">Mensaje de Bienvenida</label>
          <textarea class="form-textarea" id="msg-welcome" placeholder="Hola! Bienvenido a [Nombre Restaurante]..."></textarea>
          <div class="form-help">Se envia cuando un cliente escribe por primera vez</div>
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje de Confirmacion de Pedido</label>
          <textarea class="form-textarea" id="msg-confirmation" placeholder="Pedido confirmado! Tu orden esta siendo preparada..."></textarea>
          <div class="form-help">Se envia despues de que el cliente confirma su pedido</div>
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje de Despedida</label>
          <textarea class="form-textarea" id="msg-goodbye" placeholder="Gracias por tu pedido! Esperamos verte pronto..."></textarea>
          <div class="form-help">Se envia al finalizar la conversacion</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeMessagesModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveMessages()">Guardar Mensajes</button>
      </div>
    </div>
  </div>

  <!-- Modal: Test Bot -->
  <div class="modal-overlay" id="test-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Probar el Bot</h2>
        <button class="modal-close" onclick="closeTestModal()">x</button>
      </div>
      <div class="modal-body">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
          Tu numero de WhatsApp Business
        </h3>
        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
          <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="test-phone-number">
            Cargando...
          </div>
        </div>

        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
          Como probar el bot
        </h3>
        <ol style="padding-left: 20px; color: #4a5568; line-height: 1.8;">
          <li><strong>Abre WhatsApp</strong> en tu telefono</li>
          <li><strong>Envia un mensaje</strong> al numero de arriba</li>
          <li><strong>Escribe:</strong> "Hola" o "Menu"</li>
          <li><strong>El bot respondera</strong> con el menu automaticamente</li>
          <li><strong>Haz un pedido de prueba</strong> siguiendo las instrucciones</li>
          <li><strong>Revisa que aparezca</strong> en el KDS (pantalla de cocina)</li>
        </ol>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 16px; border-radius: 4px; margin-top: 24px;">
          <strong style="color: #856404; display: block; margin-bottom: 8px;">Nota importante:</strong>
          <p style="color: #856404; font-size: 14px; line-height: 1.6; margin: 0;">
            Si tu app aun no esta aprobada por Meta, es posible que el bot no responda aun. 
            Una vez Meta apruebe tu aplicacion, el bot empezara a funcionar automaticamente.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeTestModal()">Cerrar</button>
        <button class="btn-primary" onclick="markTestCompleted()">Ya probe el bot</button>
      </div>
    </div>
  </div>

  <!-- Modal: Payment Config -->
  <div class="modal-overlay" id="payment-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Configurar Pagos Online</h2>
        <button class="modal-close" onclick="closePaymentModal()">x</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Acepta pagos con tarjeta de credito/debito a traves de Wompi. Tus clientes pagaran online antes de confirmar el pedido.
        </p>

        <!-- Toggle de activacion -->
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f7fafc; border-radius: 8px; margin-bottom: 24px;">
            <div>
              <label class="form-label" style="margin-bottom: 4px;">Habilitar Pagos Online</label>
              <div class="form-help">Los clientes deberan pagar antes de confirmar su pedido</div>
            </div>
            <div class="bot-toggle" id="payment-toggle" onclick="togglePaymentEnabled()">
              <div class="bot-toggle-slider"></div>
            </div>
          </div>
        </div>

        <!-- Campos de credenciales (visibles solo si esta habilitado) -->
        <div id="payment-credentials-section" style="display: none;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
            Credenciales de Wompi
          </h3>
          
          <div class="form-group">
            <label class="form-label">Public Key (Llave Publica)</label>
            <input type="text" class="form-input" id="payment-public-key" placeholder="pub_test_..." autocomplete="off">
            <div class="form-help">Comienza con pub_test_ (pruebas) o pub_prod_ (produccion)</div>
          </div>

          <div class="form-group">
            <label class="form-label">Private Key (Llave Privada)</label>
            <input type="password" class="form-input" id="payment-private-key" placeholder="prv_test_..." autocomplete="off">
            <div class="form-help">Comienza con prv_test_ o prv_prod_. Nunca la compartas</div>
          </div>

          <div class="form-group">
            <label class="form-label">Integrity Secret (Secreto de Integridad)</label>
            <input type="password" class="form-input" id="payment-integrity-secret" placeholder="test_integrity_..." autocomplete="off">
            <div class="form-help">Usado para firmar transacciones</div>
          </div>

          <div class="form-group">
            <label class="form-label">Events Secret (Secreto de Eventos)</label>
            <input type="password" class="form-input" id="payment-events-secret" placeholder="test_events_..." autocomplete="off">
            <div class="form-help">Usado para validar webhooks</div>
          </div>

          <!-- Boton para probar credenciales -->
          <button class="btn-secondary" onclick="testPaymentCredentials()" style="width: 100%; margin-bottom: 24px;" id="btn-test-credentials">
            Probar Credenciales
          </button>

          <!-- Resultado de la prueba -->
          <div id="credentials-test-result" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span id="test-result-icon"></span>
              <span id="test-result-message" style="font-weight: 600;"></span>
            </div>
          </div>

          <!-- Webhook URL -->
          <div style="background: #ebf8ff; border-left: 4px solid #4299e1; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
            <h4 style="color: #2c5282; margin-bottom: 12px; font-weight: 600;">URL del Webhook</h4>
            <p style="color: #2c5282; font-size: 13px; margin-bottom: 12px; line-height: 1.6;">
              Copia esta URL y configurala en tu cuenta de Wompi (Panel - Eventos - Agregar Evento). 
              Esta URL permitira que Wompi notifique automaticamente cuando se apruebe un pago.
            </p>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input 
                type="text" 
                readonly 
                class="form-input" 
                id="webhook-url" 
                value="https://api.kdsapp.site/api/payments/webhook/wompi/TENANT_ID" 
                style="font-family: monospace; font-size: 12px; background: white;"
              >
              <button 
                class="btn-secondary" 
                onclick="copyWebhookUrl()" 
                style="flex-shrink: 0;"
              >
                Copiar
              </button>
            </div>
          </div>

          <!-- Guia rapida -->
          <div style="background: #fffaf0; border-left: 4px solid #f6ad55; padding: 16px; border-radius: 4px;">
            <h4 style="color: #7c2d12; margin-bottom: 8px; font-weight: 600;">Donde encuentro mis credenciales?</h4>
            <ol style="padding-left: 20px; color: #7c2d12; font-size: 13px; line-height: 1.8; margin: 0;">
              <li>Ingresa a tu cuenta de Wompi (<a href="https://comercios.wompi.co/login" target="_blank" style="color: #c05621; text-decoration: underline;">comercios.wompi.co</a>)</li>
              <li>Ve a <strong>Desarrollo - Programadores - Llaves del API</strong></li>
              <li>Copia las llaves y pegalas arriba</li>
              <li>Para webhooks: <strong>Desarrollo - Programadores - Pega la URL de arriba en URL de Eventos</strong></li>
            </ol>
          </div>
        </div>

        <!-- Mensaje cuando esta deshabilitado -->
        <div id="payment-disabled-message" style="background: #f7fafc; padding: 24px; border-radius: 8px; text-align: center; color: #718096;">
          <div style="font-size: 48px; margin-bottom: 16px;">Locked</div>
          <p style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">Pagos Online Deshabilitados</p>
          <p style="font-size: 14px;">Activa el interruptor arriba para configurar pagos con tarjeta.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closePaymentModal()">Cancelar</button>
        <button class="btn-primary" onclick="savePaymentConfig()" id="btn-save-payment">Guardar Configuracion</button>
      </div>
    </div>
  </div>

  <!-- Modal: Delivery Time Config -->
  <div class="modal-overlay" id="delivery-time-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Configurar Tiempo de Entrega</h2>
        <button class="modal-close" onclick="closeDeliveryTimeModal()">x</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Configura el tiempo estimado de entrega que se mostrara a tus clientes al confirmar su pedido.
        </p>

        <div class="form-group">
          <label class="form-label">Tiempo Estimado de Entrega</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="number" class="form-input" id="delivery-time-min" placeholder="30" min="10" max="120" style="flex: 1;">
            <span style="color: #4a5568; font-weight: 500;">-</span>
            <input type="number" class="form-input" id="delivery-time-max" placeholder="40" min="10" max="120" style="flex: 1;">
            <span style="color: #4a5568; font-weight: 500;">minutos</span>
          </div>
          <div class="form-help">Por ejemplo: 30-40 minutos, 20-30 minutos, etc.</div>
        </div>

        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
          <p style="font-size: 14px; color: #4a5568; margin-bottom: 8px;">
            <strong>Vista previa del mensaje:</strong>
          </p>
          <p style="color: #667eea; font-weight: 500;" id="delivery-time-preview">
            Tiempo estimado: 30-40 minutos
          </p>
        </div>

        <div style="background: #e6fffa; border-left: 4px solid #38b2ac; padding: 16px; border-radius: 4px; margin-top: 16px;">
          <strong style="color: #234e52; display: block; margin-bottom: 8px;">Recomendacion</strong>
          <p style="color: #234e52; font-size: 14px; line-height: 1.6; margin: 0;">
            Es mejor sobreestimar el tiempo de entrega. Si entregas antes, el cliente se sorprendera gratamente. 
            Si te atrasas, puede generar insatisfaccion.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDeliveryTimeModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveDeliveryTime()">Guardar Tiempo</button>
      </div>
    </div>
  </div>

  <!-- JavaScript externo -->
  <script src="js/dashboard.js"></script>
</body>
</html>
