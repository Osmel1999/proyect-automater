<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - KDS Platform</title>
  <meta name="description" content="ConfiguraciÃ³n y gestiÃ³n de tu restaurante">
  <link rel="icon" type="image/png" href="assets/images/kds-logo.png">
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <!-- Dashboard Styles -->
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">KDS</div>
      <div class="tenant-name" id="tenant-name">Cargando...</div>
    </div>
    <div class="header-right">
      <!-- WhatsApp Status -->
      <div class="whatsapp-status disconnected" id="whatsapp-status" style="display: none;">
        <span class="status-dot disconnected" id="status-dot"></span>
        <span id="status-text">Desconectado</span>
      </div>
      
      <!-- Disconnect WhatsApp Button -->
      <button class="btn-disconnect" id="btn-disconnect-whatsapp" style="display: none;" onclick="disconnectWhatsApp()">
        ğŸ“± Desconectar WhatsApp
      </button>
      
      <!-- Connect WhatsApp Button -->
      <button class="btn-connect" id="btn-connect-whatsapp" style="display: none;" onclick="connectWhatsApp()">
        ğŸ“± Conectar WhatsApp
      </button>
      
      <a href="/kds.html" class="btn-secondary" id="kdsBtn">ğŸ“º Ver KDS</a>
      <a href="/select.html" class="btn-secondary">ğŸ  Inicio</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div id="loading-container" class="loading">
      <div class="spinner"></div>
      <p>Cargando tu configuraciÃ³n...</p>
    </div>

    <!-- Bot Control Card -->
    <div id="bot-control-container" style="display: none;">
      <div class="bot-control-card" id="bot-control-card">
        <div class="bot-control-icon" id="bot-control-icon">ğŸ¤–</div>
        <div class="bot-control-content">
          <div class="bot-control-title">Bot de WhatsApp</div>
          <div class="bot-control-status" id="bot-status-text">
            <span class="status-dot"></span>
            <span id="bot-status-label">Cargando...</span>
          </div>
        </div>
        <div class="bot-toggle-container">
          <div class="bot-toggle" id="bot-toggle" onclick="toggleBot()">
            <div class="bot-toggle-slider"></div>
          </div>
          <span class="bot-toggle-label" id="bot-toggle-label">OFF</span>
        </div>
      </div>

      <!-- Warning cuando el onboarding estÃ¡ incompleto -->
      <div class="bot-warning" id="bot-warning">
        <div class="bot-warning-title">
          <span>âš ï¸</span>
          <span>Completa tu configuraciÃ³n primero</span>
        </div>
        <div class="bot-warning-text">
          Para activar el bot, debes completar al menos el 75% del onboarding (menÃº configurado y mensajes personalizados).
          Esto asegura que tus clientes tengan una buena experiencia al usar el bot.
        </div>
      </div>
    </div>

    <!-- Wizard (hidden initially) -->
    <div id="wizard-container" style="display: none;">
      <div class="wizard-card">
        <div class="wizard-header">
          <h1 class="wizard-title">ğŸš€ Â¡Bienvenido a KDS Platform!</h1>
          <p class="wizard-subtitle">Completa estos pasos para empezar a recibir pedidos automÃ¡ticamente</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
          <div class="progress-text">
            <span class="progress-label">Tu progreso</span>
            <span class="progress-percentage" id="progress-percentage">25%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill" style="width: 25%"></div>
          </div>
        </div>

        <!-- Steps -->
        <div class="steps">
          <!-- Step 1: WhatsApp -->
          <div class="step-item completed" id="step-1">
            <div class="step-icon">âœ…</div>
            <div class="step-content">
              <div class="step-title">1. Conectar WhatsApp</div>
              <div class="step-description">Tu nÃºmero de WhatsApp Business estÃ¡ conectado y listo</div>
            </div>
            <div class="step-action">
              <span class="step-status">Completado</span>
            </div>
          </div>

          <!-- Step 2: Menu -->
          <div class="step-item" id="step-2">
            <div class="step-icon">ğŸ½ï¸</div>
            <div class="step-content">
              <div class="step-title">2. Configurar tu menÃº</div>
              <div class="step-description">Agrega los productos que tus clientes pueden ordenar (5 min)</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="openMenuConfig()">Configurar â†’</button>
            </div>
          </div>

          <!-- Step 3: Messages -->
          <div class="step-item" id="step-3">
            <div class="step-icon">ğŸ’¬</div>
            <div class="step-content">
              <div class="step-title">3. Personalizar mensajes</div>
              <div class="step-description">Ajusta los mensajes automÃ¡ticos que envÃ­a el bot (3 min)</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="openMessagesConfig()">Personalizar â†’</button>
            </div>
          </div>

          <!-- Step 4: Test -->
          <div class="step-item" id="step-4">
            <div class="step-icon">ğŸ§ª</div>
            <div class="step-content">
              <div class="step-title">4. Probar el bot</div>
              <div class="step-description">EnvÃ­a un mensaje de prueba para ver cÃ³mo funciona (2 min)</div>
            </div>
            <div class="step-action">
              <button class="btn-step" onclick="openTestBot()">Probar â†’</button>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="wizard-footer">
          <button class="btn-skip" onclick="skipOnboarding()">Saltar por ahora, explorar por mi cuenta</button>
        </div>
      </div>
    </div>

    <!-- Completion Card / Dashboard (hidden initially) -->
    <div id="completion-container" style="display: none;">
      <div class="dashboard-main">
        <!-- Stats Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
              <div class="stat-label">Pedidos Hoy</div>
              <div class="stat-value" id="orders-today">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-content">
              <div class="stat-label">Ventas Hoy</div>
              <div class="stat-value" id="sales-today">$0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“±</div>
            <div class="stat-content">
              <div class="stat-label">WhatsApp</div>
              <div class="stat-value" id="whatsapp-status-main">Conectado</div>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
          <h2 class="section-title-main">ğŸš€ Acciones RÃ¡pidas</h2>
          <div class="actions-grid">
            <div class="action-card" onclick="openMenuConfig()">
              <div class="action-icon">ğŸ½ï¸</div>
              <h3>Gestionar MenÃº</h3>
              <p>Agregar, editar o eliminar productos de tu menÃº</p>
            </div>
            <div class="action-card" onclick="openMessagesConfig()">
              <div class="action-icon">ğŸ’¬</div>
              <h3>Personalizar Mensajes</h3>
              <p>Editar mensajes automÃ¡ticos del bot</p>
            </div>
            <div class="action-card" onclick="openPaymentConfig()">
              <div class="action-icon">ğŸ’³</div>
              <h3>Configurar Pagos</h3>
              <p>Activar pagos online con Wompi</p>
            </div>
            <div class="action-card" onclick="window.location.href='kds.html'">
              <div class="action-icon">ğŸ–¥ï¸</div>
              <h3>Pantalla de Cocina</h3>
              <p>Ver pedidos en tiempo real (KDS)</p>
            </div>
            <div class="action-card" onclick="viewWhatsAppInfo()">
              <div class="action-icon">ğŸ“±</div>
              <h3>Info WhatsApp</h3>
              <p>Ver nÃºmero y estado de conexiÃ³n</p>
            </div>
            <div class="action-card" onclick="openDeliveryTimeConfig()">
              <div class="action-icon">ğŸ•’</div>
              <h3>Tiempo de Entrega</h3>
              <p>Configurar tiempo estimado de entrega</p>
            </div>
          </div>
        </div>

        <!-- Menu Preview -->
        <div class="dashboard-section">
          <div class="section-header-main">
            <h2 class="section-title-main">ğŸ½ï¸ Tu MenÃº</h2>
            <button class="btn-primary" onclick="openMenuConfig()">+ Agregar Producto</button>
          </div>
          <div id="menu-list-preview" class="menu-preview-grid">
            <p style="color: #718096;">Cargando menÃº...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Menu Config -->
  <div class="modal-overlay" id="menu-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ½ï¸ Configurar MenÃº</h2>
        <button class="modal-close" onclick="closeMenuModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Agrega los productos de tu menÃº. Los clientes podrÃ¡n ordenarlos por WhatsApp.
        </p>

        <div class="form-group">
          <label class="form-label">Nombre del producto</label>
          <input type="text" class="form-input" id="item-name" placeholder="Ej: Hamburguesa ClÃ¡sica">
        </div>

        <div class="form-group">
          <label class="form-label">Precio (COP)</label>
          <input type="number" class="form-input" id="item-price" placeholder="25000">
        </div>

        <div class="form-group">
          <label class="form-label">DescripciÃ³n (opcional)</label>
          <input type="text" class="form-input" id="item-description" placeholder="Carne, lechuga, tomate...">
        </div>

        <div class="form-group">
          <label class="form-label">CategorÃ­a</label>
          <select class="form-select" id="item-category">
            <option value="Entradas">Entradas</option>
            <option value="Platos Principales">Platos Principales</option>
            <option value="Bebidas">Bebidas</option>
            <option value="Postres">Postres</option>
          </select>
        </div>

        <button class="btn-add" onclick="addMenuItem()">+ Agregar producto</button>

        <div class="menu-items" id="menu-items-list">
          <!-- Items will be added here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeMenuModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveMenu()">Guardar MenÃº</button>
      </div>
    </div>
  </div>

  <!-- Modal: Messages Config -->
  <div class="modal-overlay" id="messages-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’¬ Personalizar Mensajes</h2>
        <button class="modal-close" onclick="closeMessagesModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Personaliza los mensajes automÃ¡ticos que envÃ­a el bot a tus clientes.
        </p>

        <div class="form-group">
          <label class="form-label">Mensaje de Bienvenida</label>
          <textarea class="form-textarea" id="msg-welcome" placeholder="Â¡Hola! ğŸ‘‹ Bienvenido a [Nombre Restaurante]..."></textarea>
          <div class="form-help">Se envÃ­a cuando un cliente escribe por primera vez</div>
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje de ConfirmaciÃ³n de Pedido</label>
          <textarea class="form-textarea" id="msg-confirmation" placeholder="âœ… Â¡Pedido confirmado! Tu orden estÃ¡ siendo preparada..."></textarea>
          <div class="form-help">Se envÃ­a despuÃ©s de que el cliente confirma su pedido</div>
        </div>

        <div class="form-group">
          <label class="form-label">Mensaje de Despedida</label>
          <textarea class="form-textarea" id="msg-goodbye" placeholder="Â¡Gracias por tu pedido! ğŸ™ Esperamos verte pronto..."></textarea>
          <div class="form-help">Se envÃ­a al finalizar la conversaciÃ³n</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeMessagesModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveMessages()">Guardar Mensajes</button>
      </div>
    </div>
  </div>

  <!-- Modal: Test Bot -->
  <div class="modal-overlay" id="test-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ§ª Probar el Bot</h2>
        <button class="modal-close" onclick="closeTestModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
          ğŸ“± Tu nÃºmero de WhatsApp Business
        </h3>
        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
          <div style="font-size: 24px; font-weight: 700; color: #667eea;" id="test-phone-number">
            Cargando...
          </div>
        </div>

        <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
          âœ… CÃ³mo probar el bot
        </h3>
        <ol style="padding-left: 20px; color: #4a5568; line-height: 1.8;">
          <li><strong>Abre WhatsApp</strong> en tu telÃ©fono</li>
          <li><strong>EnvÃ­a un mensaje</strong> al nÃºmero de arriba</li>
          <li><strong>Escribe:</strong> "Hola" o "MenÃº"</li>
          <li><strong>El bot responderÃ¡</strong> con el menÃº automÃ¡ticamente</li>
          <li><strong>Haz un pedido de prueba</strong> siguiendo las instrucciones</li>
          <li><strong>Revisa que aparezca</strong> en el KDS (pantalla de cocina)</li>
        </ol>

        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 16px; border-radius: 4px; margin-top: 24px;">
          <strong style="color: #856404; display: block; margin-bottom: 8px;">âš ï¸ Nota importante:</strong>
          <p style="color: #856404; font-size: 14px; line-height: 1.6; margin: 0;">
            Si tu app aÃºn no estÃ¡ aprobada por Meta, es posible que el bot no responda aÃºn. 
            Una vez Meta apruebe tu aplicaciÃ³n, el bot empezarÃ¡ a funcionar automÃ¡ticamente.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeTestModal()">Cerrar</button>
        <button class="btn-primary" onclick="markTestCompleted()">Ya probÃ© el bot âœ“</button>
      </div>
    </div>
  </div>

  <!-- Modal: Payment Config -->
  <div class="modal-overlay" id="payment-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ’³ Configurar Pagos Online</h2>
        <button class="modal-close" onclick="closePaymentModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Acepta pagos con tarjeta de crÃ©dito/dÃ©bito a travÃ©s de Wompi. Tus clientes pagarÃ¡n online antes de confirmar el pedido.
        </p>

        <!-- Toggle de activaciÃ³n -->
        <div class="form-group">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f7fafc; border-radius: 8px; margin-bottom: 24px;">
            <div>
              <label class="form-label" style="margin-bottom: 4px;">Habilitar Pagos Online</label>
              <div class="form-help">Los clientes deberÃ¡n pagar antes de confirmar su pedido</div>
            </div>
            <div class="bot-toggle" id="payment-toggle" onclick="togglePaymentEnabled()">
              <div class="bot-toggle-slider"></div>
            </div>
          </div>
        </div>

        <!-- Campos de credenciales (visibles solo si estÃ¡ habilitado) -->
        <div id="payment-credentials-section" style="display: none;">
          <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #2d3748;">
            ğŸ”‘ Credenciales de Wompi
          </h3>
          
          <div class="form-group">
            <label class="form-label">Public Key (Llave PÃºblica)</label>
            <input type="text" class="form-input" id="payment-public-key" placeholder="pub_test_..." autocomplete="off">
            <div class="form-help">Comienza con pub_test_ (pruebas) o pub_prod_ (producciÃ³n)</div>
          </div>

          <div class="form-group">
            <label class="form-label">Private Key (Llave Privada)</label>
            <input type="password" class="form-input" id="payment-private-key" placeholder="prv_test_..." autocomplete="off">
            <div class="form-help">Comienza con prv_test_ o prv_prod_. Nunca la compartas</div>
          </div>

          <div class="form-group">
            <label class="form-label">Integrity Secret (Secreto de Integridad)</label>
            <input type="password" class="form-input" id="payment-integrity-secret" placeholder="test_integrity_..." autocomplete="off">
            <div class="form-help">Usado para firmar transacciones</div>
          </div>

          <div class="form-group">
            <label class="form-label">Events Secret (Secreto de Eventos)</label>
            <input type="password" class="form-input" id="payment-events-secret" placeholder="test_events_..." autocomplete="off">
            <div class="form-help">Usado para validar webhooks</div>
          </div>

          <!-- BotÃ³n para probar credenciales -->
          <button class="btn-secondary" onclick="testPaymentCredentials()" style="width: 100%; margin-bottom: 24px;" id="btn-test-credentials">
            ğŸ§ª Probar Credenciales
          </button>

          <!-- Resultado de la prueba -->
          <div id="credentials-test-result" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 24px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span id="test-result-icon"></span>
              <span id="test-result-message" style="font-weight: 600;"></span>
            </div>
          </div>

          <!-- Webhook URL -->
          <div style="background: #ebf8ff; border-left: 4px solid #4299e1; padding: 16px; border-radius: 4px; margin-bottom: 24px;">
            <h4 style="color: #2c5282; margin-bottom: 12px; font-weight: 600;">ğŸ“¡ URL del Webhook</h4>
            <p style="color: #2c5282; font-size: 13px; margin-bottom: 12px; line-height: 1.6;">
              Copia esta URL y configÃºrala en tu cuenta de Wompi (Panel â†’ Eventos â†’ Agregar Evento). 
              Esta URL permitirÃ¡ que Wompi notifique automÃ¡ticamente cuando se apruebe un pago.
            </p>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input 
                type="text" 
                readonly 
                class="form-input" 
                id="webhook-url" 
                value="https://api.kdsapp.site/api/payments/webhook/wompi/TENANT_ID" 
                style="font-family: monospace; font-size: 12px; background: white;"
              >
              <button 
                class="btn-secondary" 
                onclick="copyWebhookUrl()" 
                style="flex-shrink: 0;"
              >
                ğŸ“‹ Copiar
              </button>
            </div>
          </div>

          <!-- GuÃ­a rÃ¡pida -->
          <div style="background: #fffaf0; border-left: 4px solid #f6ad55; padding: 16px; border-radius: 4px;">
            <h4 style="color: #7c2d12; margin-bottom: 8px; font-weight: 600;">ğŸ“š Â¿DÃ³nde encuentro mis credenciales?</h4>
            <ol style="padding-left: 20px; color: #7c2d12; font-size: 13px; line-height: 1.8; margin: 0;">
              <li>Ingresa a tu cuenta de Wompi (<a href="https://comercios.wompi.co/login" target="_blank" style="color: #c05621; text-decoration: underline;">comercios.wompi.co</a>)</li>
              <li>Ve a <strong>Desarrollo â†’ Programadores â†’ Llaves del API</strong></li>
              <li>Copia las llaves y pÃ©galas arriba</li>
              <li>Para webhooks: <strong>Desarrollo â†’ Programadores â†’ Pega la URL de arriba en URL de Eventos</strong></li>
            </ol>
          </div>
        </div>

        <!-- Mensaje cuando estÃ¡ deshabilitado -->
        <div id="payment-disabled-message" style="background: #f7fafc; padding: 24px; border-radius: 8px; text-align: center; color: #718096;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”’</div>
          <p style="font-weight: 600; color: #4a5568; margin-bottom: 8px;">Pagos Online Deshabilitados</p>
          <p style="font-size: 14px;">Activa el interruptor arriba para configurar pagos con tarjeta.</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closePaymentModal()">Cancelar</button>
        <button class="btn-primary" onclick="savePaymentConfig()" id="btn-save-payment">Guardar ConfiguraciÃ³n</button>
      </div>
    </div>
  </div>

  <!-- Modal: Delivery Time Config -->
  <div class="modal-overlay" id="delivery-time-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ğŸ•’ Configurar Tiempo de Entrega</h2>
        <button class="modal-close" onclick="closeDeliveryTimeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 24px; color: #718096;">
          Configura el tiempo estimado de entrega que se mostrarÃ¡ a tus clientes al confirmar su pedido.
        </p>

        <div class="form-group">
          <label class="form-label">Tiempo Estimado de Entrega</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="number" class="form-input" id="delivery-time-min" placeholder="30" min="10" max="120" style="flex: 1;">
            <span style="color: #4a5568; font-weight: 500;">-</span>
            <input type="number" class="form-input" id="delivery-time-max" placeholder="40" min="10" max="120" style="flex: 1;">
            <span style="color: #4a5568; font-weight: 500;">minutos</span>
          </div>
          <div class="form-help">Por ejemplo: 30-40 minutos, 20-30 minutos, etc.</div>
        </div>

        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; margin-top: 16px;">
          <p style="font-size: 14px; color: #4a5568; margin-bottom: 8px;">
            <strong>Vista previa del mensaje:</strong>
          </p>
          <p style="color: #667eea; font-weight: 500;" id="delivery-time-preview">
            ğŸ•’ Tiempo estimado: 30-40 minutos
          </p>
        </div>

        <div style="background: #e6fffa; border-left: 4px solid #38b2ac; padding: 16px; border-radius: 4px; margin-top: 16px;">
          <strong style="color: #234e52; display: block; margin-bottom: 8px;">ğŸ’¡ RecomendaciÃ³n</strong>
          <p style="color: #234e52; font-size: 14px; line-height: 1.6; margin: 0;">
            Es mejor sobreestimar el tiempo de entrega. Si entregas antes, el cliente se sorprenderÃ¡ gratamente. 
            Si te atrasas, puede generar insatisfacciÃ³n.
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeDeliveryTimeModal()">Cancelar</button>
        <button class="btn-primary" onclick="saveDeliveryTime()">Guardar Tiempo</button>
      </div>
    </div>
  </div>

  <!-- Firebase Config -->
  <script src="config.js"></script>
  
  <!-- Dashboard Script -->
  <script src="js/dashboard.js"></script>
</body>
</html>
